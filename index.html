<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>ä¸Šä¸Šç­¾æ°´æ™¶æ‰‹é“¾è®¾è®¡å™¨</title>
    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script>
        // å¤‡ç”¨åŠ è½½OrbitControls
        window.addEventListener('load', function () {
            if (typeof THREE !== 'undefined' && !THREE.OrbitControls) {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js';
                script.onerror = function () {
                    console.warn('OrbitControlsåŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨åŸºæœ¬æ§åˆ¶');
                };
                document.head.appendChild(script);
            }
        });
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 70vh;
            gap: 0;
        }

        .controls {
            flex: 1;
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
        }

        .preview {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            position: relative;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            z-index: 10;
            position: relative;
        }

        .view-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .view-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .download-btn {
            background: #28a745;
            border: 2px solid #28a745;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            font-weight: 500;
            color: white;
        }

        .download-btn:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .download-btn:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .canvas-container {
            position: relative;
            width: 400px;
            height: 400px;
        }

        #threejs-container {
            width: 100%;
            height: 100%;
            border: 4px solid #667eea;
            border-radius: 20px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            box-shadow:
                0 15px 35px rgba(102, 126, 234, 0.3),
                inset 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23667eea" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="%23764ba2" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="%23667eea" opacity="0.03"/><circle cx="10" cy="50" r="0.5" fill="%23764ba2" opacity="0.03"/><circle cx="90" cy="30" r="0.5" fill="%23667eea" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: 1;
        }

        .preview-title {
            color: #667eea;
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .preview .bracelet-canvas {
            position: relative;
            z-index: 2;
        }

        .preview .preview-info {
            position: relative;
            z-index: 2;
        }

        .control-group {
            margin-bottom: 30px;
        }

        .control-group h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .crystal-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.5);
        }

        .crystal-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.85em;
            position: relative;
        }

        .crystal-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .crystal-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .crystal-image {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.8);
        }

        .crystal-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .crystal-option:hover .crystal-image img {
            transform: scale(1.1);
        }



        .crystal-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            max-width: 300px;
            z-index: 1003;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .crystal-tooltip.show {
            opacity: 1;
        }

        .crystal-tooltip::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 5px solid transparent;
        }

        .crystal-tooltip.arrow-top::before {
            top: -10px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-bottom-color: rgba(0, 0, 0, 0.9);
        }

        .crystal-tooltip.arrow-bottom::before {
            bottom: -10px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .crystal-tooltip.arrow-left::before {
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-right-color: rgba(0, 0, 0, 0.9);
        }

        .crystal-tooltip.arrow-right::before {
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-left-color: rgba(0, 0, 0, 0.9);
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #667eea;
        }

        .tooltip-category {
            font-size: 0.8em;
            color: #ccc;
            margin-bottom: 8px;
        }

        .tooltip-description {
            line-height: 1.4;
        }

        .bead-count-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .count-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .count-btn:hover {
            background: #5a6fd8;
            transform: scale(1.1);
        }

        #current-bead-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }

        .auto-calc-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auto-calc-btn:hover {
            background: #218838;
        }

        .bead-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 15px;
        }

        .bead-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .bead-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .bead-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .bead-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bead-preview:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .bead-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bead-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .size-selector {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .size-selector:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .bead-info {
            font-size: 0.85em;
            color: #666;
            flex: 1;
        }

        .bead-size {
            font-size: 0.8em;
            color: #667eea;
            font-weight: 600;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }



        .crystal-palette {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .crystal-categories {
            max-height: 70vh;
            overflow-y: auto;
        }



        .crystal-categories {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            min-height: 0;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .crystal-categories::-webkit-scrollbar {
            width: 8px;
        }

        .crystal-categories::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .crystal-categories::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .crystal-categories::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .category-section {
            margin-bottom: 25px;
            border-radius: 15px;
            background: rgba(102, 126, 234, 0.05);
            padding: 15px;
        }

        .category-title {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            padding-bottom: 8px;
        }

        .crystal-palette .crystal-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            background: transparent;
            padding: 0;
            margin-bottom: 0;
        }

        .palette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .close-palette {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .close-palette:hover {
            color: #333;
        }

        .size-options,
        .circumference-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .option-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 60px;
            text-align: center;
            font-size: 0.9em;
        }

        .option-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .bracelet-canvas {
            width: 400px;
            height: 400px;
            border: 4px solid #667eea;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #f8f9fa 50%, #e8e8e8 100%);
            box-shadow:
                inset 0 0 30px rgba(0, 0, 0, 0.15),
                0 15px 35px rgba(102, 126, 234, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .bracelet-canvas:hover {
            transform: scale(1.02);
            box-shadow:
                inset 0 0 30px rgba(0, 0, 0, 0.15),
                0 20px 40px rgba(102, 126, 234, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .bracelet-canvas::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }



        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 30px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls,
            .preview {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                margin: 0;
                border-radius: 10px;
            }

            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1em;
            }

            .main-content {
                flex-direction: column;
                min-height: auto;
                gap: 0;
            }

            .controls {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                padding: 15px;
            }

            .preview {
                padding: 15px;
            }

            .preview-title {
                font-size: 1.3em;
                margin-bottom: 15px;
            }

            .canvas-container {
                width: 300px;
                height: 300px;
            }

            .bracelet-canvas {
                width: 300px;
                height: 300px;
            }

            #threejs-container {
                width: 100%;
                height: 100%;
            }

            .view-toggle {
                gap: 8px;
                margin-bottom: 15px;
            }

            .view-btn {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            .download-btn {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            /* æ§åˆ¶é¢æ¿ä¼˜åŒ– */
            .control-group {
                margin-bottom: 20px;
            }

            .control-group h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }

            .circumference-options,
            .size-options {
                gap: 6px;
            }

            .option-btn {
                padding: 8px 12px;
                font-size: 0.85em;
                min-width: 50px;
            }

            .bead-count-controls {
                gap: 10px;
                justify-content: center;
            }

            .count-btn {
                width: 35px;
                height: 35px;
                font-size: 1.1em;
            }

            #current-bead-count {
                font-size: 1.3em;
                min-width: 35px;
            }

            .auto-calc-btn {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            .bead-list {
                max-height: 250px;
                padding: 10px;
            }

            .bead-item {
                padding: 8px;
                margin-bottom: 8px;
                gap: 10px;
            }

            .bead-number {
                width: 25px;
                height: 25px;
                font-size: 0.8em;
            }

            .bead-preview {
                width: 35px;
                height: 35px;
            }

            .bead-info {
                font-size: 0.8em;
            }

            .bead-size {
                font-size: 0.75em;
                padding: 1px 6px;
                margin-left: 5px;
            }

            .generate-btn {
                padding: 12px 25px;
                font-size: 1em;
                margin-top: 20px;
            }

            /* æ°´æ™¶é€‰æ‹©é¢æ¿ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .crystal-palette {
                max-width: 95vw;
                max-height: 90vh;
                padding: 15px;
                border-radius: 15px;
                margin: 10px;
                transform: translate(-50%, -50%);
            }

            .crystal-palette h3 {
                font-size: 1.1em;
                margin-bottom: 15px;
            }

            .palette-search input {
                padding: 8px;
                font-size: 13px;
            }

            .palette-stats {
                flex-direction: column;
                gap: 5px;
                font-size: 0.8em;
                text-align: center;
            }

            .crystal-categories {
                max-height: 60vh;
            }

            .category-section {
                margin-bottom: 20px;
                padding: 10px;
            }

            .category-title {
                font-size: 1em;
                margin-bottom: 10px;
                padding-bottom: 5px;
            }

            .crystal-palette .crystal-types {
                grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
                gap: 8px;
            }

            .crystal-option {
                padding: 8px;
                font-size: 0.8em;
            }

            .crystal-image {
                width: 40px;
                height: 40px;
                margin-bottom: 5px;
            }

            .close-palette {
                top: 8px;
                right: 12px;
                font-size: 1.3em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 0.9em;
            }

            .controls,
            .preview {
                padding: 10px;
            }

            .preview-title {
                font-size: 1.2em;
                margin-bottom: 10px;
            }

            .canvas-container {
                width: 250px;
                height: 250px;
            }

            .bracelet-canvas {
                width: 250px;
                height: 250px;
            }

            #threejs-container {
                width: 100%;
                height: 100%;
            }

            .view-toggle {
                gap: 5px;
                margin-bottom: 10px;
            }

            .view-btn {
                padding: 5px 10px;
                font-size: 0.8em;
                border-radius: 15px;
            }

            .download-btn {
                padding: 5px 10px;
                font-size: 0.8em;
                border-radius: 15px;
            }

            /* è¶…å°å±å¹•æ§åˆ¶é¢æ¿ä¼˜åŒ– */
            .control-group {
                margin-bottom: 15px;
            }

            .control-group h3 {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .circumference-options,
            .size-options {
                gap: 4px;
            }

            .option-btn {
                padding: 6px 10px;
                font-size: 0.8em;
                min-width: 45px;
                border-radius: 15px;
            }

            .bead-count-controls {
                gap: 8px;
            }

            .count-btn {
                width: 30px;
                height: 30px;
                font-size: 1em;
            }

            #current-bead-count {
                font-size: 1.2em;
                min-width: 30px;
            }

            .auto-calc-btn {
                padding: 5px 10px;
                font-size: 0.8em;
                border-radius: 15px;
            }

            .bead-list {
                max-height: 200px;
                padding: 8px;
            }

            .bead-item {
                padding: 6px;
                margin-bottom: 6px;
                gap: 8px;
            }

            .bead-number {
                width: 22px;
                height: 22px;
                font-size: 0.75em;
            }

            .bead-preview {
                width: 30px;
                height: 30px;
            }

            .bead-info {
                font-size: 0.75em;
            }

            .bead-size {
                font-size: 0.7em;
                padding: 1px 5px;
                margin-left: 3px;
            }

            .generate-btn {
                padding: 10px 20px;
                font-size: 0.9em;
                margin-top: 15px;
                border-radius: 20px;
            }

            /* æ°´æ™¶é€‰æ‹©é¢æ¿è¶…å°å±ä¼˜åŒ– */
            .crystal-palette {
                max-width: 98vw;
                max-height: 95vh;
                padding: 10px;
                border-radius: 10px;
                margin: 5px;
            }

            .crystal-palette h3 {
                font-size: 1em;
                margin-bottom: 10px;
            }

            .palette-search input {
                padding: 6px;
                font-size: 12px;
                border-radius: 15px;
            }

            .palette-stats {
                font-size: 0.75em;
                gap: 3px;
            }

            .crystal-categories {
                max-height: 65vh;
            }

            .category-section {
                margin-bottom: 15px;
                padding: 8px;
            }

            .category-title {
                font-size: 0.9em;
                margin-bottom: 8px;
                padding-bottom: 3px;
            }

            .crystal-palette .crystal-types {
                grid-template-columns: repeat(auto-fit, minmax(65px, 1fr));
                gap: 6px;
            }

            .crystal-option {
                padding: 6px;
                font-size: 0.75em;
                border-radius: 8px;
            }

            .crystal-image {
                width: 35px;
                height: 35px;
                margin-bottom: 3px;
            }

            .close-palette {
                top: 5px;
                right: 8px;
                font-size: 1.2em;
            }

            /* æç¤ºæ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .crystal-tooltip {
                max-width: 250px;
                padding: 8px 12px;
                font-size: 0.8em;
                border-radius: 6px;
            }

            .tooltip-title {
                font-size: 0.85em;
                margin-bottom: 3px;
            }

            .tooltip-category {
                font-size: 0.7em;
                margin-bottom: 5px;
            }

            .tooltip-description {
                font-size: 0.75em;
                line-height: 1.3;
            }
        }

        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-content {
                flex-direction: row;
            }

            .controls {
                flex: 0 0 45%;
                border-right: 1px solid #e0e0e0;
                border-bottom: none;
                max-height: 70vh;
                overflow-y: auto;
            }

            .preview {
                flex: 1;
                padding: 10px;
            }

            .canvas-container {
                width: 280px;
                height: 280px;
            }

            .bracelet-canvas {
                width: 280px;
                height: 280px;
            }

            #threejs-container {
                width: 100%;
                height: 100%;
            }

            .bead-list {
                max-height: 150px;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {

            /* ç¦ç”¨æ‰€æœ‰hoveræ•ˆæœ */
            .crystal-option:hover,
            .bead-preview:hover,
            .option-btn:hover,
            .view-btn:hover,
            .download-btn:hover,
            .generate-btn:hover,
            .count-btn:hover,
            .auto-calc-btn:hover,
            .bead-item:hover,
            .size-selector:hover,
            .close-palette:hover,
            .bracelet-canvas:hover {
                transform: none !important;
                box-shadow: initial !important;
                border-color: initial !important;
                background: initial !important;
                scale: none !important;
            }

            .crystal-option:hover .crystal-image img {
                transform: none !important;
            }

            /* ä½¿ç”¨activeçŠ¶æ€æ›¿ä»£hover */
            .crystal-option:active,
            .bead-preview:active,
            .option-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            .view-btn:active,
            .download-btn:active,
            .generate-btn:active,
            .count-btn:active,
            .auto-calc-btn:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }

            /* ä¸ºé€‰ä¸­çŠ¶æ€æ·»åŠ æ›´æ˜æ˜¾çš„è§†è§‰åé¦ˆ */
            .option-btn.selected {
                background: #667eea !important;
                color: white !important;
                border-color: #667eea !important;
                box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3) !important;
            }

            .crystal-option.selected {
                transform: scale(1.05);
                box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4) !important;
            }

            /* å¢å¤§è§¦æ‘¸ç›®æ ‡ */
            .crystal-option {
                min-height: 44px;
                padding: 10px;
            }

            .option-btn {
                min-height: 44px;
                padding: 10px 16px;
            }

            .count-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .view-btn,
            .download-btn {
                min-height: 44px;
                padding: 10px 16px;
            }

            .generate-btn {
                min-height: 48px;
                padding: 15px 30px;
            }

            /* ç§»åŠ¨ç«¯ä¸“ç”¨çš„è§†è§‰åé¦ˆ */
            .mobile-pressed {
                transform: scale(0.95) !important;
                transition: transform 0.1s ease !important;
            }

            .mobile-selected {
                background: rgba(102, 126, 234, 0.1) !important;
                border-color: #667eea !important;
            }

            /* ç§»åŠ¨ç«¯æ°´æ™¶é€‰é¡¹å¢å¼º */
            .crystal-option {
                position: relative;
            }

            .crystal-option::after {
                content: 'é•¿æŒ‰æŸ¥çœ‹è¯¦æƒ…';
                position: absolute;
                bottom: -2px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 10px;
                color: #999;
                opacity: 0.7;
                white-space: nowrap;
            }

            /* ç§»åŠ¨ç«¯tooltipæ ·å¼å¢å¼º */
            .mobile-crystal-tooltip {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
        }

        /* é¢„è§ˆåŒºç‰ˆæƒä¿¡æ¯æ ·å¼ */
        .preview-copyright {
            transition: opacity 0.3s ease;
        }

        .preview-copyright:hover {
            opacity: 1 !important;
        }

        .preview-copyright p {
            margin: 0;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>âœ¨ ä¸Šä¸Šç­¾æ°´æ™¶æ‰‹é“¾è®¾è®¡å™¨ âœ¨</h1>
            <p>é€‰æ‹©æ‚¨å–œæ¬¢çš„æ°´æ™¶ç ï¼Œå®šåˆ¶ä¸“å±æ‰‹é“¾</p>
        </div>

        <div class="main-content">
            <div class="controls">
                <div class="control-group">
                    <h3>â­• åœˆå£å¤§å°</h3>
                    <div class="circumference-options">
                        <div class="option-btn" data-circumference="13">13cm</div>
                        <div class="option-btn" data-circumference="14">14cm</div>
                        <div class="option-btn" data-circumference="15">15cm</div>
                        <div class="option-btn" data-circumference="16">16cm</div>
                        <div class="option-btn" data-circumference="17">17cm</div>
                        <div class="option-btn" data-circumference="18">18cm</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>ğŸ”¢ ç å­æ•°é‡</h3>
                    <div class="bead-count-controls">
                        <button class="count-btn" onclick="changeBeadCount(-1)">-</button>
                        <span id="current-bead-count">10</span>
                        <button class="count-btn" onclick="changeBeadCount(1)">+</button>
                        <button class="auto-calc-btn" onclick="autoCalculateBeads()"
                            title="æ ¹æ®åœˆå£å¤§å°å’Œç å­å°ºå¯¸è‡ªåŠ¨è®¡ç®—åˆé€‚çš„ç å­æ•°é‡ã€‚å°ç å­(4-6mm)å¯å®¹çº³æ›´å¤šé¢—ï¼Œå¤§ç å­(12-16mm)æ•°é‡ç›¸å¯¹è¾ƒå°‘ï¼Œç¡®ä¿ç å­é—´æœ‰é€‚å½“é—´è·">è‡ªåŠ¨è®¡ç®—</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>ğŸ“ ç å­å°ºå¯¸</h3>
                    <div class="size-options">
                        <div class="option-btn" data-size="4">4mm</div>
                        <div class="option-btn" data-size="6">6mm</div>
                        <div class="option-btn" data-size="8">8mm</div>
                        <div class="option-btn" data-size="10">10mm</div>
                        <div class="option-btn" data-size="12">12mm</div>
                        <div class="option-btn selected" data-size="14">14mm</div>
                        <div class="option-btn" data-size="16">16mm</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>ğŸ’ ç å­é…ç½®</h3>
                    <div class="bead-list" id="bead-list">
                        <!-- ç å­é…ç½®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="control-group crystal-palette" style="display: none;">
                    <h3 style="flex-shrink: 0; margin-bottom: 20px;">ğŸ”® æ°´æ™¶ç åº“</h3>
                    <div class="palette-search" style="flex-shrink: 0;">
                        <input type="text" id="crystal-search" placeholder="æœç´¢æ°´æ™¶åç§°..."
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 20px; margin-bottom: 15px; font-size: 14px;">
                        <div class="palette-stats"
                            style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 0.9em; color: #666;">
                            <span>ğŸ’œç´«(8) ğŸŒ¸ç²‰(6) ğŸ¤ç™½(6) ğŸ’šç»¿(6) ğŸ’™è“(5)</span>
                            <span>ğŸ’›é»„(9) â¤ï¸çº¢(3) ğŸ–¤é»‘(7) ğŸ§¡æ©™(1) ğŸ¤æ£•(1) ğŸ©¶ç°(3) âœ¨å…¶ä»–(5)</span>
                        </div>
                    </div>
                    <div class="crystal-categories">
                        <!-- æ°´æ™¶é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <button class="generate-btn" onclick="generateBracelet()">ç”Ÿæˆæ‰‹é“¾é¢„è§ˆ</button>
            </div>

            <div class="preview">
                <h2 class="preview-title">ğŸ”® æ‰‹é“¾é¢„è§ˆæ•ˆæœ</h2>

                <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('2d')">2D å¹³é¢å›¾</button>
                    <button class="view-btn" onclick="switchView('3d')">3D ç«‹ä½“å›¾</button>
                </div>

                <!-- ç”»å¸ƒå®¹å™¨ -->
                <div class="canvas-container">
                    <canvas id="braceletCanvas" class="bracelet-canvas" width="400" height="400"></canvas>
                    <div id="threejs-container" style="display: none;"></div>
                </div>

                <div class="preview-info" style="margin-top: 25px; text-align: center; color: #888; font-size: 0.85em;">
                    <div id="view-instructions">ç‚¹å‡»"ç”Ÿæˆæ‰‹é“¾é¢„è§ˆ"æŸ¥çœ‹æ•ˆæœ</div>
                </div>

                <!-- ä¸‹è½½æŒ‰é’® -->
                <div class="download-section" style="margin-top: 20px; text-align: center;">
                    <button class="download-btn" onclick="download2DImage()" title="ä¸‹è½½2Dæ•ˆæœå›¾">ğŸ“¥ ä¸‹è½½æ•ˆæœå›¾</button>
                </div>

                <!-- ç‰ˆæƒä¿¡æ¯ -->
                <!-- <div class="preview-copyright"
                    style="margin-top: 20px; text-align: center; color: #888; font-size: 0.85em; opacity: 0.8;">
                    <p>&copy; 2025 liwen. All rights reserved.</p>
                </div> -->
            </div>
        </div>
    </div>



    <script>
        // æ°´æ™¶ç é…ç½® - 60ç§ç å­
        const crystalConfig = {
            // ç´«è‰²ç³»åˆ—
            'amethyst': {
                name: 'ç´«æ°´æ™¶',
                color: '#9966cc',
                gradient: ['#9966cc', '#663399'],
                category: 'ç´«',
                description: 'æ™ºæ…§ä¹‹çŸ³ï¼Œæœ‰åŠ©äºå¼€å‘æ™ºæ…§ã€æé«˜ç›´è§‰åŠ›ï¼Œå¹³å¤æƒ…ç»ªï¼Œæ”¹å–„ç¡çœ è´¨é‡ã€‚è¢«èª‰ä¸º"è¯šå®ä¹‹çŸ³"ï¼Œèƒ½å¢å¼ºè®°å¿†åŠ›å’Œæ³¨æ„åŠ›ã€‚'
            },
            'purple-mica': {
                name: 'ç´«äº‘æ¯',
                color: '#9370db',
                gradient: ['#9370db', '#663399'],
                category: 'ç´«',
                description: 'å…·æœ‰å¼ºå¤§çš„å‡€åŒ–èƒ½åŠ›ï¼Œèƒ½å¤Ÿæ¸…é™¤è´Ÿèƒ½é‡ï¼Œæå‡ç²¾ç¥å±‚æ¬¡ã€‚æœ‰åŠ©äºå†¥æƒ³å’Œçµæ€§æˆé•¿ï¼Œå¢å¼ºç›´è§‰å’Œæ´å¯ŸåŠ›ã€‚'
            },
            'purple-rabbit-hair': {
                name: 'ç´«å…”æ¯›',
                color: '#8a2be2',
                gradient: ['#8a2be2', '#4b0082'],
                category: 'ç´«',
                description: 'æ¸©å’Œçš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¹³è¡¡æƒ…ç»ªï¼Œå‡è½»å‹åŠ›å’Œç„¦è™‘ã€‚æœ‰åŠ©äºæå‡åˆ›é€ åŠ›å’Œè‰ºæœ¯çµæ„Ÿï¼Œä¿ƒè¿›å†…å¿ƒå¹³é™ã€‚'
            },
            'purple-phantom': {
                name: 'ç´«å¹½çµ',
                color: '#9932cc',
                gradient: ['#9932cc', '#6a0dad'],
                category: 'ç´«',
                description: 'ç¥ç§˜çš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºç¬¬å…­æ„Ÿå’Œç›´è§‰åŠ›ã€‚æœ‰åŠ©äºçµæ€§ä¿®è¡Œï¼Œæå‡æ„è¯†å±‚æ¬¡ï¼Œä¿ƒè¿›å†…åœ¨æˆé•¿ã€‚'
            },
            'purple-lithium-mica': {
                name: 'ç´«é”‚äº‘æ¯',
                color: '#da70d6',
                gradient: ['#da70d6', '#ba55d3'],
                category: 'ç´«',
                description: 'æƒ…ç»ªå¹³è¡¡çŸ³ï¼Œå«æœ‰å¤©ç„¶é”‚å…ƒç´ ï¼Œèƒ½å¤Ÿç¨³å®šæƒ…ç»ªï¼Œç¼“è§£æŠ‘éƒå’Œç„¦è™‘ã€‚æœ‰åŠ©äºé‡Šæ”¾å‹åŠ›ï¼Œå¸¦æ¥å†…å¿ƒå®é™ã€‚'
            },
            'purple-spodumene': {
                name: 'ç´«é”‚è¾‰',
                color: '#dda0dd',
                gradient: ['#dda0dd', '#9370db'],
                category: 'ç´«',
                description: 'å¿ƒçµæ²»æ„ˆçŸ³ï¼Œèƒ½å¤Ÿæ²»æ„ˆæƒ…æ„Ÿåˆ›ä¼¤ï¼Œé‡Šæ”¾è¿‡å»çš„ç—›è‹¦ã€‚æœ‰åŠ©äºè‡ªæˆ‘æ¥çº³å’Œå®½æ•ï¼Œä¿ƒè¿›å¿ƒçµæˆé•¿ã€‚'
            },
            'charoite': {
                name: 'ç´«é¾™æ™¶',
                color: '#8b7d6b',
                gradient: ['#8b7d6b', '#696969'],
                category: 'ç´«',
                description: 'è½¬åŒ–ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå°†è´Ÿé¢èƒ½é‡è½¬åŒ–ä¸ºæ­£é¢åŠ›é‡ã€‚æœ‰åŠ©äºå…‹æœææƒ§ï¼Œå¢å¼ºå‹‡æ°”å’Œå†³å¿ƒï¼Œä¿ƒè¿›ä¸ªäººè½¬å˜ã€‚'
            },
            'super-seven': {
                name: 'è¶…ä¸ƒ',
                color: '#9966cc',
                gradient: ['#9966cc', '#663399'],
                category: 'ç´«',
                description: 'ä¸ƒç§çŸ¿ç‰©çš„å®Œç¾ç»“åˆï¼Œå…·æœ‰å¼ºå¤§çš„èƒ½é‡åœºã€‚èƒ½å¤Ÿæå‡çµæ€§è§‰çŸ¥ï¼Œå¢å¼ºç›´è§‰åŠ›ï¼Œä¿ƒè¿›å…¨æ–¹ä½çš„èº«å¿ƒçµå¹³è¡¡ã€‚'
            },

            // ç²‰è‰²ç³»åˆ—
            'rose-quartz': {
                name: 'ç²‰æ°´æ™¶',
                color: '#ffb6c1',
                gradient: ['#ffb6c1', '#ff69b4'],
                category: 'ç²‰',
                description: 'çˆ±æƒ…ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¸å¼•çˆ±æƒ…ï¼Œå¢è¿›äººé™…å…³ç³»ã€‚æœ‰åŠ©äºè‡ªæˆ‘ç–—æ„ˆï¼Œæå‡è‡ªä¿¡å¿ƒï¼Œä¿ƒè¿›å†…å¿ƒçš„çˆ±ä¸å’Œè°ã€‚'
            },
            'cherry-blossom-agate': {
                name: 'æ¨±èŠ±ç›ç‘™',
                color: '#ffb7c5',
                gradient: ['#ffb7c5', '#ff91a4'],
                category: 'ç²‰',
                description: 'æ¸©æŸ”çš„å®ˆæŠ¤çŸ³ï¼Œè±¡å¾ç€çº¯æ´çš„çˆ±æƒ…å’Œç¾å¥½çš„æ„¿æœ›ã€‚èƒ½å¤Ÿå¸¦æ¥å¥½è¿ï¼Œå¢å¼ºå¥³æ€§é­…åŠ›ï¼Œä¿ƒè¿›æ„Ÿæƒ…å’Œè°ã€‚'
            },
            'pink-phantom': {
                name: 'ç²‰å¹½çµ',
                color: '#ffc0cb',
                gradient: ['#ffc0cb', '#ff69b4'],
                category: 'ç²‰',
                description: 'æ‹›è´¢è¿›å®çš„ç²‰è‰²èƒ½é‡ï¼Œèƒ½å¤Ÿå¸å¼•è´¢å¯Œå’Œæœºé‡ã€‚æœ‰åŠ©äºäº‹ä¸šå‘å±•ï¼Œå¢å¼ºäººé™…å…³ç³»ï¼Œå¸¦æ¥æ¸©å’Œçš„æ­£èƒ½é‡ã€‚'
            },
            'rhodochrosite': {
                name: 'çº¢çº¹çŸ³',
                color: '#f08080',
                gradient: ['#f08080', '#cd5c5c'],
                category: 'ç²‰',
                description: 'å¿ƒè½®æ²»æ„ˆçŸ³ï¼Œèƒ½å¤Ÿæ²»æ„ˆæƒ…æ„Ÿåˆ›ä¼¤ï¼Œé‡Šæ”¾å†…å¿ƒçš„ç—›è‹¦ã€‚æœ‰åŠ©äºè‡ªæˆ‘æ¥çº³å’Œçˆ±ï¼Œä¿ƒè¿›æƒ…æ„Ÿçš„å¹³è¡¡ä¸å’Œè°ã€‚'
            },
            'strawberry-quartz': {
                name: 'è‰è“æ™¶',
                color: '#ff6b9d',
                gradient: ['#ff6b9d', '#c44569'],
                category: 'ç²‰',
                description: 'ç”œç¾çš„çˆ±æƒ…çŸ³ï¼Œèƒ½å¤Ÿå¢è¿›æ‹äººé—´çš„æ„Ÿæƒ…ï¼Œå¸¦æ¥ç”œèœœçš„çˆ±æƒ…ã€‚æœ‰åŠ©äºæå‡ä¸ªäººé­…åŠ›ï¼Œå¢å¼ºè‡ªä¿¡å’Œå¿«ä¹ã€‚'
            },
            'rose-stone': {
                name: 'è”·è–‡çŸ³',
                color: '#ffc0cb',
                gradient: ['#ffc0cb', '#ff69b4'],
                category: 'ç²‰',
                description: 'ä¼˜é›…çš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿæå‡æ°”è´¨å’Œå“å‘³ã€‚æœ‰åŠ©äºå¢å¼ºå¥³æ€§æŸ”ç¾ç‰¹è´¨ï¼Œä¿ƒè¿›å†…åœ¨ç¾çš„ç»½æ”¾ã€‚'
            },

            // ç™½è‰²ç³»åˆ—
            'clear-quartz': {
                name: 'ç™½æ°´æ™¶',
                color: '#ffffff',
                gradient: ['#ffffff', '#f0f0f0'],
                category: 'ç™½',
                description: 'ä¸‡èƒ½æ°´æ™¶ä¹‹ç‹ï¼Œå…·æœ‰å¼ºå¤§çš„å‡€åŒ–å’Œæ”¾å¤§èƒ½é‡çš„ä½œç”¨ã€‚èƒ½å¤Ÿæ¸…é™¤è´Ÿèƒ½é‡ï¼Œæå‡æ­£èƒ½é‡ï¼Œå¢å¼ºå…¶ä»–æ°´æ™¶çš„åŠŸæ•ˆã€‚'
            },
            'milky-quartz': {
                name: 'å¥¶ç™½æ™¶',
                color: '#fffaf0',
                gradient: ['#fffaf0', '#f5f5dc'],
                category: 'ç™½',
                description: 'æ¸©å’Œçš„æ²»æ„ˆçŸ³ï¼Œèƒ½å¤Ÿå¸¦æ¥å†…å¿ƒçš„å¹³é™å’Œå®‰å®ã€‚æœ‰åŠ©äºç¼“è§£å‹åŠ›ï¼Œä¿ƒè¿›ç¡çœ ï¼Œå¢å¼ºèº«ä½“çš„è‡ªæ„ˆèƒ½åŠ›ã€‚'
            },
            'pearl': {
                name: 'çç ',
                color: '#f8f8ff',
                gradient: ['#f8f8ff', '#e6e6fa'],
                category: 'ç™½',
                description: 'æµ·æ´‹çš„é¦ˆèµ ï¼Œè±¡å¾çº¯æ´å’Œæ™ºæ…§ã€‚èƒ½å¤Ÿå¹³è¡¡æƒ…ç»ªï¼Œå¢å¼ºå¥³æ€§é­…åŠ›ï¼Œä¿ƒè¿›å†…åœ¨çš„ä¼˜é›…å’Œæ°”è´¨ã€‚'
            },
            'white-phantom': {
                name: 'ç™½å¹½çµ',
                color: '#f5f5f5',
                gradient: ['#f5f5f5', '#dcdcdc'],
                category: 'ç™½',
                description: 'å‡€åŒ–ä¹‹çŸ³ï¼Œèƒ½å¤Ÿæ¸…é™¤èº«å¿ƒçš„è´Ÿèƒ½é‡ï¼Œæå‡çµæ€§è§‰çŸ¥ã€‚æœ‰åŠ©äºå†¥æƒ³å’Œç²¾ç¥ä¿®è¡Œï¼Œä¿ƒè¿›å†…åœ¨çš„çº¯å‡€ã€‚'
            },
            'moonstone': {
                name: 'ç™½æœˆå…‰',
                color: '#f8f8ff',
                gradient: ['#f8f8ff', '#e6e6fa'],
                category: 'ç™½',
                description: 'æœˆäº®çš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¹³è¡¡é˜´æ€§èƒ½é‡ï¼Œå¢å¼ºç›´è§‰åŠ›ã€‚æœ‰åŠ©äºå¥³æ€§å¥åº·ï¼Œä¿ƒè¿›æƒ…æ„Ÿçš„ç¨³å®šå’Œå†…åœ¨çš„æ™ºæ…§ã€‚'
            },
            'white-agate': {
                name: 'ç™½é˜¿å¡',
                color: '#f0f8ff',
                gradient: ['#f0f8ff', '#e6e6fa'],
                category: 'ç™½',
                description: 'å¹³è¡¡ä¹‹çŸ³ï¼Œèƒ½å¤Ÿç¨³å®šæƒ…ç»ªï¼Œå¢å¼ºå†…åœ¨åŠ›é‡ã€‚æœ‰åŠ©äºæå‡ä¸“æ³¨åŠ›ï¼Œä¿ƒè¿›èº«å¿ƒçš„å¹³è¡¡ä¸å’Œè°ã€‚'
            },

            // ç»¿è‰²ç³»åˆ—
            'amazonite': {
                name: 'å¤©æ²³çŸ³',
                color: '#40e0d0',
                gradient: ['#40e0d0', '#20b2aa'],
                category: 'ç»¿',
                description: 'çœŸç†ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºæ²Ÿé€šèƒ½åŠ›ï¼Œä¿ƒè¿›çœŸè¯šçš„è¡¨è¾¾ã€‚æœ‰åŠ©äºç¼“è§£å‹åŠ›ï¼Œå¸¦æ¥å†…å¿ƒçš„å¹³é™å’Œå‹‡æ°”ã€‚'
            },
            'xiuyan-jade': {
                name: 'å²«ç‰',
                color: '#90ee90',
                gradient: ['#90ee90', '#228b22'],
                category: 'ç»¿',
                description: 'ä¸­åä¼ ç»Ÿç‰çŸ³ï¼Œè±¡å¾å‰ç¥¥å’Œå¹³å®‰ã€‚èƒ½å¤Ÿè°ƒå’Œé˜´é˜³ï¼Œä¿ƒè¿›èº«ä½“å¥åº·ï¼Œå¸¦æ¥å¥½è¿å’Œè´¢å¯Œã€‚'
            },
            'green-phantom': {
                name: 'ç»¿å¹½çµ',
                color: '#32cd32',
                gradient: ['#32cd32', '#228b22'],
                category: 'ç»¿',
                description: 'è´¢å¯Œä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¸å¼•è´¢è¿å’Œäº‹ä¸šæˆåŠŸã€‚æœ‰åŠ©äºå¢å¼ºå†³ç­–åŠ›ï¼Œä¿ƒè¿›äº‹ä¸šå‘å±•ï¼Œå¸¦æ¥ç‰©è´¨ä¸Šçš„ä¸°ç››ã€‚'
            },
            'green-quartz': {
                name: 'ç»¿æ°´æ™¶',
                color: '#90ee90',
                gradient: ['#90ee90', '#228b22'],
                category: 'ç»¿',
                description: 'å¿ƒè½®æ²»æ„ˆçŸ³ï¼Œèƒ½å¤Ÿå¹³è¡¡å¿ƒè½®èƒ½é‡ï¼Œä¿ƒè¿›æƒ…æ„Ÿçš„å’Œè°ã€‚æœ‰åŠ©äºé‡Šæ”¾å«‰å¦’å’Œæ„¤æ€’ï¼Œå¸¦æ¥å†…å¿ƒçš„å¹³é™ã€‚'
            },
            'green-fluorite': {
                name: 'ç»¿è¤çŸ³',
                color: '#98fb98',
                gradient: ['#98fb98', '#90ee90'],
                category: 'ç»¿',
                description: 'å­¦ä¹ ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºä¸“æ³¨åŠ›å’Œè®°å¿†åŠ›ã€‚æœ‰åŠ©äºæ¸…ç†æ€ç»´ï¼Œæå‡å­¦ä¹ æ•ˆç‡ï¼Œä¿ƒè¿›æ™ºåŠ›å‘å±•ã€‚'
            },
            'prehnite': {
                name: 'è‘¡è„çŸ³',
                color: '#9acd32',
                gradient: ['#9acd32', '#6b8e23'],
                category: 'ç»¿',
                description: 'é¢„è¨€ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºç›´è§‰å’Œé¢„çŸ¥èƒ½åŠ›ã€‚æœ‰åŠ©äºå†¥æƒ³å’Œçµæ€§ä¿®è¡Œï¼Œä¿ƒè¿›å†…åœ¨æ™ºæ…§çš„è§‰é†’ã€‚'
            },

            // è“è‰²ç³»åˆ—
            'labradorite': {
                name: 'æ‹‰é•¿çŸ³',
                color: '#4682b4',
                gradient: ['#4682b4', '#2f4f4f'],
                category: 'è“',
                description: 'é­”æ³•ä¹‹çŸ³ï¼Œå…·æœ‰ç¥ç§˜çš„å˜å½©æ•ˆåº”ã€‚èƒ½å¤Ÿå¢å¼ºç›´è§‰åŠ›ï¼Œä¿æŠ¤èƒ½é‡åœºï¼Œä¿ƒè¿›çµæ€§è§‰é†’å’Œè½¬åŒ–ã€‚'
            },
            'aquamarine': {
                name: 'æµ·è“å®',
                color: '#7fffd4',
                gradient: ['#7fffd4', '#40e0d0'],
                category: 'è“',
                description: 'æµ·æ´‹çš„å®çŸ³ï¼Œèƒ½å¤Ÿå¸¦æ¥å¹³é™å’Œæ¸…æ™°çš„æ€ç»´ã€‚æœ‰åŠ©äºæ²Ÿé€šè¡¨è¾¾ï¼Œå¢å¼ºå‹‡æ°”ï¼Œä¿ƒè¿›å†…åœ¨çš„å®é™ã€‚'
            },
            'kyanite': {
                name: 'è“æ™¶çŸ³',
                color: '#4169e1',
                gradient: ['#4169e1', '#0000cd'],
                category: 'è“',
                description: 'é«˜é¢‘èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ¸…ç†å’Œå¹³è¡¡è„‰è½®ã€‚æœ‰åŠ©äºå†¥æƒ³å’Œçµæ€§ä¿®è¡Œï¼Œä¿ƒè¿›æ„è¯†çš„æå‡ã€‚'
            },
            'blue-moonstone': {
                name: 'è“æœˆå…‰',
                color: '#87ceeb',
                gradient: ['#87ceeb', '#4682b4'],
                category: 'è“',
                description: 'æƒ…æ„Ÿå¹³è¡¡çŸ³ï¼Œèƒ½å¤Ÿç¨³å®šæƒ…ç»ªæ³¢åŠ¨ï¼Œå¢å¼ºç›´è§‰åŠ›ã€‚æœ‰åŠ©äºå¥³æ€§å¥åº·ï¼Œä¿ƒè¿›å†…åœ¨çš„æ™ºæ…§å’Œæ´å¯ŸåŠ›ã€‚'
            },
            'blue-chalcedony': {
                name: 'è“ç‰é«“',
                color: '#87ceeb',
                gradient: ['#87ceeb', '#4682b4'],
                category: 'è“',
                description: 'æ²Ÿé€šä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºè¡¨è¾¾èƒ½åŠ›ï¼Œä¿ƒè¿›å’Œè°çš„äººé™…å…³ç³»ã€‚æœ‰åŠ©äºç¼“è§£ç´§å¼ æƒ…ç»ªï¼Œå¸¦æ¥å†…å¿ƒçš„å¹³é™ã€‚'
            },

            // é»„è‰²ç³»åˆ—
            'citrine': {
                name: 'é»„æ°´æ™¶',
                color: '#ffd700',
                gradient: ['#ffd700', '#ffb347'],
                category: 'é»„',
                description: 'è´¢å¯Œä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¸å¼•è´¢è¿å’ŒæˆåŠŸã€‚æœ‰åŠ©äºå¢å¼ºè‡ªä¿¡å¿ƒï¼Œæå‡ä¸ªäººé­…åŠ›ï¼Œä¿ƒè¿›äº‹ä¸šå’Œè´¢å¯Œçš„å¢é•¿ã€‚'
            },
            'amber': {
                name: 'èœœèœ¡',
                color: '#ffbf00',
                gradient: ['#ffbf00', '#ff8c00'],
                category: 'é»„',
                description: 'å¤è€çš„æœ‰æœºå®çŸ³ï¼Œå…·æœ‰å¼ºå¤§çš„æ²»æ„ˆèƒ½é‡ã€‚èƒ½å¤Ÿå‡€åŒ–è´Ÿèƒ½é‡ï¼Œå¢å¼ºç”Ÿå‘½åŠ›ï¼Œä¿ƒè¿›èº«å¿ƒå¥åº·ã€‚'
            },
            'golden-tiger-eye': {
                name: 'é‡‘è™çœ¼',
                color: '#cd853f',
                gradient: ['#cd853f', '#8b4513'],
                category: 'é»„',
                description: 'å‹‡æ°”ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºæ„å¿—åŠ›å’Œå†³å¿ƒã€‚æœ‰åŠ©äºæå‡è‡ªä¿¡ï¼Œå¢å¼ºæ´å¯ŸåŠ›ï¼Œå¸¦æ¥å¥½è¿å’Œä¿æŠ¤ã€‚'
            },
            'golden-rutilated-quartz': {
                name: 'é‡‘å‘æ™¶',
                color: '#ffd700',
                gradient: ['#ffd700', '#daa520'],
                category: 'é»„',
                description: 'è´¢å¯Œå’ŒæƒåŠ›çš„è±¡å¾ï¼Œèƒ½å¤Ÿå¸å¼•è´¢è¿å’ŒæˆåŠŸã€‚æœ‰åŠ©äºå¢å¼ºé¢†å¯¼åŠ›ï¼Œæå‡ä¸ªäººæ°”åœºå’Œå½±å“åŠ›ã€‚'
            },
            'yellow-tower-crystal': {
                name: 'é»„å¡”æ™¶',
                color: '#ffff00',
                gradient: ['#ffff00', '#ffd700'],
                category: 'é»„',
                description: 'æ™ºæ…§ä¹‹å¡”ï¼Œèƒ½å¤Ÿå¢å¼ºæ€ç»´èƒ½åŠ›å’Œåˆ›é€ åŠ›ã€‚æœ‰åŠ©äºå­¦ä¹ å’Œå·¥ä½œï¼Œæå‡ä¸“æ³¨åŠ›å’Œæ•ˆç‡ã€‚'
            },
            'yellow-flower-amber': {
                name: 'é»„èƒ¶èŠ±',
                color: '#ffb347',
                gradient: ['#ffb347', '#ff8c00'],
                category: 'é»„',
                description: 'æ¸©æš–çš„æ²»æ„ˆçŸ³ï¼Œèƒ½å¤Ÿå¸¦æ¥å¿«ä¹å’Œç§¯æçš„èƒ½é‡ã€‚æœ‰åŠ©äºç¼“è§£æŠ‘éƒï¼Œå¢å¼ºç”Ÿå‘½æ´»åŠ›ã€‚'
            },
            'yellow-tiger-eye': {
                name: 'é»„è™çœ¼',
                color: '#daa520',
                gradient: ['#daa520', '#b8860b'],
                category: 'é»„',
                description: 'ä¿æŠ¤ä¹‹çŸ³ï¼Œèƒ½å¤ŸæŠµå¾¡è´Ÿèƒ½é‡ï¼Œå¢å¼ºä¸ªäººåŠ›é‡ã€‚æœ‰åŠ©äºæå‡è‡ªä¿¡å¿ƒï¼Œå¸¦æ¥å¥½è¿å’ŒæˆåŠŸã€‚'
            },
            'yellow-agate': {
                name: 'é»„é˜¿å¡',
                color: '#f0e68c',
                gradient: ['#f0e68c', '#daa520'],
                category: 'é»„',
                description: 'ç¨³å®šä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¹³è¡¡æƒ…ç»ªï¼Œå¢å¼ºå†…åœ¨åŠ›é‡ã€‚æœ‰åŠ©äºæå‡ä¸“æ³¨åŠ›ï¼Œä¿ƒè¿›èº«å¿ƒçš„ç¨³å®šã€‚'
            },
            'black-gold-super': {
                name: 'é»‘é‡‘è¶…',
                color: '#2f4f4f',
                gradient: ['#2f4f4f', '#000000'],
                category: 'é»„',
                description: 'å¼ºå¤§çš„èƒ½é‡çŸ³ï¼Œç»“åˆäº†é»‘è‰²çš„ä¿æŠ¤åŠ›å’Œé‡‘è‰²çš„è´¢å¯Œèƒ½é‡ã€‚èƒ½å¤Ÿå¸¦æ¥æˆåŠŸå’Œä¿æŠ¤ã€‚'
            },

            // çº¢è‰²ç³»åˆ—
            'garnet': {
                name: 'çŸ³æ¦´çŸ³',
                color: '#8b0000',
                gradient: ['#8b0000', '#4a0000'],
                category: 'çº¢',
                description: 'æ¿€æƒ…ä¹‹çŸ³ï¼Œèƒ½å¤Ÿæ¿€å‘å†…åœ¨çš„çƒ­æƒ…å’Œæ´»åŠ›ã€‚æœ‰åŠ©äºå¢å¼ºè¡€æ¶²å¾ªç¯ï¼Œæå‡ç”Ÿå‘½åŠ›ï¼Œä¿ƒè¿›çˆ±æƒ…å’Œå‹è°Šã€‚'
            },
            'cinnabar': {
                name: 'æœ±ç ‚',
                color: '#dc143c',
                gradient: ['#dc143c', '#8b0000'],
                category: 'çº¢',
                description: 'ä¼ ç»Ÿçš„è¾Ÿé‚ªåœ£å“ï¼Œèƒ½å¤Ÿé©±é™¤é‚ªæ°”ï¼Œå¸¦æ¥å¥½è¿ã€‚æœ‰åŠ©äºå¢å¼ºæ­£èƒ½é‡ï¼Œä¿æŠ¤èº«å¿ƒå¥åº·ã€‚'
            },
            'red-flower-amber': {
                name: 'çº¢èƒ¶èŠ±',
                color: '#ff6347',
                gradient: ['#ff6347', '#dc143c'],
                category: 'çº¢',
                description: 'çƒ­æƒ…çš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿæ¿€å‘åˆ›é€ åŠ›å’Œè¡ŒåŠ¨åŠ›ã€‚æœ‰åŠ©äºå¢å¼ºè‡ªä¿¡å¿ƒï¼Œå¸¦æ¥æˆåŠŸå’Œå¥½è¿ã€‚'
            },

            // é»‘è‰²ç³»åˆ—
            'obsidian': {
                name: 'é»‘æ›œçŸ³',
                color: '#2f2f2f',
                gradient: ['#2f2f2f', '#000000'],
                category: 'é»‘',
                description: 'å¼ºå¤§çš„ä¿æŠ¤çŸ³ï¼Œèƒ½å¤ŸæŠµå¾¡è´Ÿèƒ½é‡å’Œé‚ªæ°”ã€‚æœ‰åŠ©äºæ¥åœ°å’Œç¨³å®šï¼Œä¿ƒè¿›å†…åœ¨åŠ›é‡çš„è§‰é†’ã€‚'
            },
            'venom-stone': {
                name: 'æ¯’æ¶²',
                color: '#1c1c1c',
                gradient: ['#1c1c1c', '#000000'],
                category: 'é»‘',
                description: 'ç¥ç§˜çš„èƒ½é‡çŸ³ï¼Œå…·æœ‰å¼ºå¤§çš„è½¬åŒ–åŠ›é‡ã€‚èƒ½å¤Ÿå°†è´Ÿé¢èƒ½é‡è½¬åŒ–ä¸ºæ­£é¢åŠ›é‡ï¼Œä¿ƒè¿›ä¸ªäººæˆé•¿ã€‚'
            },
            'golden-obsidian': {
                name: 'é‡‘æ›œçŸ³',
                color: '#2f2f2f',
                gradient: ['#2f2f2f', '#000000'],
                category: 'é»‘',
                description: 'è´¢å¯Œä¸ä¿æŠ¤çš„ç»“åˆï¼Œèƒ½å¤Ÿå¸å¼•è´¢è¿åŒæ—¶æä¾›å¼ºå¤§ä¿æŠ¤ã€‚æœ‰åŠ©äºå¢å¼ºä¸ªäººåŠ›é‡å’ŒæˆåŠŸè¿åŠ¿ã€‚'
            },
            'silver-obsidian': {
                name: 'é“¶æ›œçŸ³',
                color: '#2f2f2f',
                gradient: ['#2f2f2f', '#000000'],
                category: 'é»‘',
                description: 'æœˆäº®èƒ½é‡çš„ä¿æŠ¤çŸ³ï¼Œèƒ½å¤Ÿå¹³è¡¡é˜´æ€§èƒ½é‡ï¼Œå¢å¼ºç›´è§‰åŠ›ã€‚æœ‰åŠ©äºæƒ…æ„Ÿæ²»æ„ˆå’Œç²¾ç¥ä¿æŠ¤ã€‚'
            },
            'flash-stone': {
                name: 'é—ªçµ',
                color: '#1c1c1c',
                gradient: ['#1c1c1c', '#000000'],
                category: 'é»‘',
                description: 'é«˜é¢‘èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ¸…ç†è´Ÿèƒ½é‡ï¼Œæå‡æŒ¯åŠ¨é¢‘ç‡ã€‚æœ‰åŠ©äºçµæ€§è§‰é†’å’Œæ„è¯†æå‡ã€‚'
            },
            'black-rutilated-quartz': {
                name: 'é»‘å‘æ™¶',
                color: '#2f2f2f',
                gradient: ['#2f2f2f', '#000000'],
                category: 'é»‘',
                description: 'å¼ºå¤§çš„ä¿æŠ¤å’Œå‡€åŒ–çŸ³ï¼Œèƒ½å¤Ÿæ¸…é™¤è´Ÿèƒ½é‡ï¼Œå¢å¼ºä¸ªäººåŠ›é‡ã€‚æœ‰åŠ©äºæå‡é¢†å¯¼åŠ›å’Œå†³æ–­åŠ›ã€‚'
            },
            'black-gold-backbone': {
                name: 'é»‘é‡‘éª¨å¹²',
                color: '#2f2f2f',
                gradient: ['#2f2f2f', '#000000'],
                category: 'é»‘',
                description: 'åšéŸ§ä¸æ‹”çš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºæ„å¿—åŠ›å’Œæ¯…åŠ›ã€‚æœ‰åŠ©äºå…‹æœå›°éš¾ï¼Œå®ç°ç›®æ ‡å’Œæ¢¦æƒ³ã€‚'
            },

            // æ©™è‰²ç³»åˆ—
            'sunstone': {
                name: 'å¤ªé˜³çŸ³',
                color: '#ff8c00',
                gradient: ['#ff8c00', '#ff4500'],
                category: 'æ©™',
                description: 'å¤ªé˜³çš„èƒ½é‡çŸ³ï¼Œèƒ½å¤Ÿå¸¦æ¥å¿«ä¹å’Œç§¯æçš„èƒ½é‡ã€‚æœ‰åŠ©äºå¢å¼ºè‡ªä¿¡å¿ƒï¼Œæå‡ç”Ÿå‘½æ´»åŠ›ï¼Œé©±æ•£é˜´éœ¾ã€‚'
            },

            // æ£•è‰²ç³»åˆ—
            'smoky-quartz': {
                name: 'èŒ¶æ°´æ™¶',
                color: '#8b4513',
                gradient: ['#8b4513', '#654321'],
                category: 'æ£•',
                description: 'æ¥åœ°ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¸®åŠ©é‡Šæ”¾è´Ÿé¢æƒ…ç»ªï¼Œå¢å¼ºç¨³å®šæ„Ÿã€‚æœ‰åŠ©äºç¼“è§£å‹åŠ›å’Œç„¦è™‘ï¼Œä¿ƒè¿›å†…åœ¨å¹³é™ã€‚'
            },

            // ç°è‰²ç³»åˆ—
            'gray-rabbit-hair': {
                name: 'ç°å…”æ¯›',
                color: '#808080',
                gradient: ['#808080', '#696969'],
                category: 'ç°',
                description: 'æ¸©å’Œçš„å¹³è¡¡çŸ³ï¼Œèƒ½å¤Ÿè°ƒå’Œå„ç§èƒ½é‡ï¼Œå¸¦æ¥å†…åœ¨çš„å’Œè°ã€‚æœ‰åŠ©äºç¼“è§£æƒ…ç»ªæ³¢åŠ¨ï¼Œä¿ƒè¿›å¿ƒç†å¹³è¡¡ã€‚'
            },
            'gray-moonstone': {
                name: 'ç°æœˆå…‰',
                color: '#a9a9a9',
                gradient: ['#a9a9a9', '#808080'],
                category: 'ç°',
                description: 'æ™ºæ…§ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºç›´è§‰å’Œæ´å¯ŸåŠ›ã€‚æœ‰åŠ©äºå†¥æƒ³å’Œç²¾ç¥ä¿®è¡Œï¼Œä¿ƒè¿›å†…åœ¨æ™ºæ…§çš„è§‰é†’ã€‚'
            },
            'hawk-eye': {
                name: 'é¹°çœ¼çŸ³',
                color: '#708090',
                gradient: ['#708090', '#2f4f4f'],
                category: 'ç°',
                description: 'æ´å¯Ÿä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºè§‚å¯ŸåŠ›å’Œåˆ¤æ–­åŠ›ã€‚æœ‰åŠ©äºçœ‹æ¸…äº‹ç‰©æœ¬è´¨ï¼Œåšå‡ºæ­£ç¡®çš„å†³ç­–ã€‚'
            },

            // å…¶ä»–ç‰¹æ®Šç³»åˆ—
            'four-season-phantom': {
                name: 'å››å­£å¹½çµ',
                color: '#90ee90',
                gradient: ['#90ee90', '#228b22'],
                category: 'å…¶ä»–',
                description: 'æ—¶é—´çš„è§è¯è€…ï¼ŒåŒ…å«å››å­£çš„èƒ½é‡å˜åŒ–ã€‚èƒ½å¤Ÿå¸®åŠ©é€‚åº”å˜åŒ–ï¼Œä¿ƒè¿›æˆé•¿å’Œè½¬åŒ–ã€‚'
            },
            'multi-treasure': {
                name: 'å¤šå®',
                color: '#dda0dd',
                gradient: ['#dda0dd', '#9370db'],
                category: 'å…¶ä»–',
                description: 'å¤šç§çŸ¿ç‰©çš„å®Œç¾ç»“åˆï¼Œå…·æœ‰ä¸°å¯Œçš„èƒ½é‡å±‚æ¬¡ã€‚èƒ½å¤Ÿå¸¦æ¥å¤šæ–¹é¢çš„å¥½è¿å’Œç¥ç¦ã€‚'
            },
            'small-tree-amber': {
                name: 'å°æ ‘èƒ¶èŠ±',
                color: '#ffb347',
                gradient: ['#ffb347', '#ff8c00'],
                category: 'å…¶ä»–',
                description: 'ç”Ÿå‘½ä¹‹æ ‘çš„èƒ½é‡ï¼Œè±¡å¾æˆé•¿å’Œç¹è£ã€‚èƒ½å¤Ÿä¿ƒè¿›ä¸ªäººå‘å±•ï¼Œå¸¦æ¥ç”Ÿæœºå’Œæ´»åŠ›ã€‚'
            },
            'sandalwood': {
                name: 'æª€æœ¨',
                color: '#8b4513',
                gradient: ['#8b4513', '#654321'],
                category: 'å…¶ä»–',
                description: 'ç¥åœ£çš„æœ¨è´¨èƒ½é‡ï¼Œå…·æœ‰å‡€åŒ–å’Œå®‰ç¥çš„ä½œç”¨ã€‚æœ‰åŠ©äºå†¥æƒ³å’Œç²¾ç¥ä¿®è¡Œï¼Œå¸¦æ¥å†…å¿ƒçš„å®é™ã€‚'
            },
            'fluorite': {
                name: 'è¤çŸ³',
                color: '#9370db',
                gradient: ['#9370db', '#663399'],
                category: 'å…¶ä»–',
                description: 'å¤©æ‰ä¹‹çŸ³ï¼Œèƒ½å¤Ÿå¢å¼ºæ™ºåŠ›å’Œå­¦ä¹ èƒ½åŠ›ã€‚æœ‰åŠ©äºæ¸…ç†æ€ç»´ï¼Œæå‡ä¸“æ³¨åŠ›å’Œåˆ›é€ åŠ›ã€‚'
            }
        };

        let selectedCircumference = 15; // é»˜è®¤åœˆå£
        let currentBeadCount = 10; // é»˜è®¤ç å­æ•°é‡
        let uniformBeadSize = 14; // ç»Ÿä¸€ç å­å°ºå¯¸
        let beadConfigs = []; // å­˜å‚¨æ¯é¢—ç å­çš„é…ç½®
        let currentEditingBead = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç å­ç´¢å¼•
        let currentView = '2d'; // å½“å‰è§†å›¾æ¨¡å¼
        let scene, camera, renderer, controls; // Three.js å¯¹è±¡
        let braceletGroup; // æ‰‹é“¾3Då¯¹è±¡ç»„

        // åˆå§‹åŒ–ç å­é…ç½®
        function initializeBeads() {
            console.log('åˆå§‹åŒ–ç å­é…ç½®...');
            console.log('å½“å‰ç å­æ•°é‡:', currentBeadCount);
            console.log('ç»Ÿä¸€å°ºå¯¸:', uniformBeadSize);

            beadConfigs = [];
            for (let i = 0; i < currentBeadCount; i++) {
                beadConfigs.push({
                    crystal: 'amethyst', // é»˜è®¤ç´«æ°´æ™¶
                    size: uniformBeadSize // ä½¿ç”¨ç»Ÿä¸€å°ºå¯¸
                });
            }

            console.log('åˆå§‹åŒ–å®Œæˆï¼ŒbeadConfigs:', beadConfigs);
            updateBeadList();
            updateInfo();
        }

        // æ›´æ”¹ç å­æ•°é‡
        function changeBeadCount(delta) {
            const newCount = currentBeadCount + delta;

            // æ ¹æ®ç å­å°ºå¯¸åŠ¨æ€è°ƒæ•´æ•°é‡èŒƒå›´
            const minCount = uniformBeadSize <= 6 ? 5 : 3;
            const maxCount = uniformBeadSize <= 6 ? 50 : (uniformBeadSize <= 10 ? 40 : 30);

            if (newCount >= minCount && newCount <= maxCount) {
                currentBeadCount = newCount;
                document.getElementById('current-bead-count').textContent = currentBeadCount;

                // è°ƒæ•´ç å­é…ç½®æ•°ç»„
                if (delta > 0) {
                    // å¢åŠ ç å­
                    for (let i = 0; i < delta; i++) {
                        beadConfigs.push({
                            crystal: 'amethyst',
                            size: uniformBeadSize
                        });
                    }
                } else {
                    // å‡å°‘ç å­
                    beadConfigs = beadConfigs.slice(0, currentBeadCount);
                }

                updateBeadList();
                updateInfo();
                generateBracelet();
            }
        }

        // è‡ªåŠ¨è®¡ç®—ç å­æ•°é‡
        function autoCalculateBeads() {
            const circumferenceInMm = selectedCircumference * 10;

            // æ ¹æ®ç å­å°ºå¯¸è°ƒæ•´æœ€å°é—´è·
            let minSpacingPerBead;
            if (uniformBeadSize <= 6) {
                minSpacingPerBead = 0.5; // å°ç å­é—´è·å¯ä»¥æ›´å°
            } else if (uniformBeadSize <= 10) {
                minSpacingPerBead = 0.8; // ä¸­ç­‰ç å­
            } else {
                minSpacingPerBead = 1.0; // å¤§ç å­éœ€è¦æ›´å¤§é—´è·
            }

            const effectiveSpacePerBead = uniformBeadSize + minSpacingPerBead;

            // è®¡ç®—å¯å®¹çº³çš„ç å­æ•°é‡
            const calculatedCount = Math.floor(circumferenceInMm / effectiveSpacePerBead);

            // éªŒè¯è®¡ç®—ç»“æœï¼Œç¡®ä¿ä¸ä¼šé‡å 
            const totalBeadSpace = calculatedCount * uniformBeadSize;
            const totalSpacing = circumferenceInMm - totalBeadSpace;
            const spacingPerBead = totalSpacing / calculatedCount;

            // å¦‚æœé—´è·å¤ªå°ï¼Œå‡å°‘ç å­æ•°é‡
            let finalCount = calculatedCount;
            if (spacingPerBead < minSpacingPerBead * 0.5) {
                finalCount = Math.floor(circumferenceInMm / (uniformBeadSize + minSpacingPerBead * 0.5));
            }

            // æ ¹æ®ç å­å°ºå¯¸è°ƒæ•´æ•°é‡èŒƒå›´
            const minCount = uniformBeadSize <= 6 ? 5 : 3;
            const maxCount = uniformBeadSize <= 6 ? 50 : (uniformBeadSize <= 10 ? 40 : 30);

            if (finalCount !== currentBeadCount && finalCount >= minCount && finalCount <= maxCount) {
                currentBeadCount = finalCount;
                document.getElementById('current-bead-count').textContent = currentBeadCount;
                initializeBeads();
                generateBracelet();

                // æ˜¾ç¤ºè®¡ç®—ç»“æœä¿¡æ¯
                const actualSpacing = (circumferenceInMm - finalCount * uniformBeadSize) / finalCount;
                console.log(`è‡ªåŠ¨è®¡ç®—ç»“æœ: ${finalCount}é¢—ç å­ (${uniformBeadSize}mm), å¹³å‡é—´è·: ${actualSpacing.toFixed(1)}mm`);
            }
        }

        // æ›´æ–°ç å­åˆ—è¡¨æ˜¾ç¤º
        function updateBeadList() {
            const beadList = document.getElementById('bead-list');
            beadList.innerHTML = '';

            beadConfigs.forEach((bead, index) => {
                const crystal = crystalConfig[bead.crystal];
                const beadItem = document.createElement('div');
                beadItem.className = 'bead-item';
                beadItem.innerHTML = `
                    <div class="bead-number">${index + 1}</div>
                    <div class="bead-preview" onclick="openCrystalPalette(${index})">
                        <img src="static/ã€${getCrystalColorPrefix(bead.crystal)}ã€‘${crystal.name}.png" alt="${crystal.name}" />
                    </div>
                    <div class="bead-controls">
                        <div class="bead-info">${crystal.name}</div>
                        <div class="bead-size">${uniformBeadSize}mm</div>
                    </div>
                `;
                beadList.appendChild(beadItem);
            });
        }

        // è·å–æ°´æ™¶é¢œè‰²å‰ç¼€
        function getCrystalColorPrefix(crystalType) {
            const crystal = crystalConfig[crystalType];
            if (!crystal) return 'ç™½';

            // æ ¹æ®categoryè¿”å›å¯¹åº”çš„é¢œè‰²å‰ç¼€
            const categoryMap = {
                'ç´«': 'ç´«',
                'ç²‰': 'ç²‰',
                'ç™½': 'ç™½',
                'ç»¿': 'ç»¿',
                'è“': 'è“',
                'é»„': 'é»„',
                'çº¢': 'çº¢',
                'é»‘': 'é»‘',
                'æ©™': 'æ©™',
                'æ£•': 'æ£•',
                'ç°': 'ç°',
                'å…¶ä»–': 'å…¶ä»–'
            };

            return categoryMap[crystal.category] || 'ç™½';
        }

        // æ›´æ–°ç»Ÿä¸€ç å­å°ºå¯¸
        function updateUniformBeadSize(size) {
            uniformBeadSize = parseInt(size);
            // æ›´æ–°æ‰€æœ‰ç å­çš„å°ºå¯¸
            beadConfigs.forEach(bead => {
                bead.size = uniformBeadSize;
            });
            updateBeadList();
            updateInfo();
            generateBracelet();
        }

        // æ‰“å¼€æ°´æ™¶é€‰æ‹©é¢æ¿
        function openCrystalPalette(beadIndex) {
            currentEditingBead = beadIndex;
            const palette = document.querySelector('.crystal-palette');
            const overlay = document.createElement('div');
            overlay.className = 'palette-overlay';
            overlay.onclick = closeCrystalPalette;

            document.body.appendChild(overlay);
            palette.style.display = 'block';

            // ç§»åŠ¨ç«¯ä¼˜åŒ–
            optimizeMobilePalette();

            // æ·»åŠ å…³é—­æŒ‰é’®
            if (!palette.querySelector('.close-palette')) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-palette';
                closeBtn.innerHTML = 'Ã—';
                closeBtn.onclick = closeCrystalPalette;
                palette.appendChild(closeBtn);
            }

            // ç§»åŠ¨ç«¯æ—¶é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            if (isMobileDevice()) {
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
            }
        }

        // å…³é—­æ°´æ™¶é€‰æ‹©é¢æ¿
        function closeCrystalPalette() {
            const palette = document.querySelector('.crystal-palette');
            const overlay = document.querySelector('.palette-overlay');

            palette.style.display = 'none';
            if (overlay) {
                overlay.remove();
            }
            currentEditingBead = null;

            // æ¢å¤ç§»åŠ¨ç«¯èƒŒæ™¯æ»šåŠ¨
            if (isMobileDevice()) {
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
            }

            // æ¸…ç©ºæœç´¢æ¡†
            const searchInput = document.getElementById('crystal-search');
            if (searchInput) {
                searchInput.value = '';
                filterCrystals('');
            }
        }

        // åˆ›å»ºæ‚¬åœæç¤ºæ¡†
        function createTooltip() {
            const tooltip = document.createElement('div');
            tooltip.className = 'crystal-tooltip';
            document.body.appendChild(tooltip);
            return tooltip;
        }

        // æ˜¾ç¤ºæ‚¬åœæç¤º
        function showTooltip(crystalType, event) {
            const crystal = crystalConfig[crystalType];
            if (!crystal) return;

            let tooltip = document.querySelector('.crystal-tooltip');
            if (!tooltip) {
                tooltip = createTooltip();
            }

            tooltip.innerHTML = `
                <div class="tooltip-title">${crystal.name}</div>
                <div class="tooltip-category">${crystal.category}è‰²ç³»åˆ—</div>
                <div class="tooltip-description">${crystal.description}</div>
            `;

            // å…ˆæ˜¾ç¤ºtooltipä»¥è·å–æ­£ç¡®çš„å°ºå¯¸
            tooltip.style.visibility = 'hidden';
            tooltip.classList.add('show');

            // è®¡ç®—ä½ç½®
            const crystalOption = event.target.closest('.crystal-option');
            const rect = crystalOption.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            // ç»Ÿä¸€æ˜¾ç¤ºåœ¨æ°´æ™¶é€‰é¡¹ä¸‹æ–¹
            const originalLeft = rect.left + rect.width / 2 - tooltipRect.width / 2;
            let left = originalLeft;
            let top = rect.bottom + 10;
            let arrowClass = 'arrow-top';

            // è¾¹ç•Œæ£€æŸ¥ - åªå¤„ç†å·¦å³è¾¹ç•Œå’Œåº•éƒ¨è¾¹ç•Œ
            if (left < 10) {
                left = 10;
            }
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
            if (top + tooltipRect.height > window.innerHeight - 10) {
                top = rect.top - tooltipRect.height - 10;
                arrowClass = 'arrow-bottom';
            }

            // è®¡ç®—ç®­å¤´ä½ç½® - è®©ç®­å¤´æŒ‡å‘æ°´æ™¶é€‰é¡¹çš„ä¸­å¿ƒ
            const crystalCenterX = rect.left + rect.width / 2;
            const tooltipLeftEdge = left;
            const arrowLeftPercent = Math.max(10, Math.min(90, ((crystalCenterX - tooltipLeftEdge) / tooltipRect
                .width) * 100));

            // æ¸…é™¤æ‰€æœ‰ç®­å¤´ç±»å¹¶åº”ç”¨æ–°çš„
            tooltip.className = 'crystal-tooltip show ' + arrowClass;
            tooltip.style.setProperty('--arrow-left', arrowLeftPercent + '%');
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.visibility = 'visible';
        }

        // éšè—æ‚¬åœæç¤º
        function hideTooltip() {
            const tooltip = document.querySelector('.crystal-tooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        // ç§»åŠ¨ç«¯æ˜¾ç¤ºtooltip
        function showMobileTooltip(crystalOption, event) {
            if (!isMobileDevice()) return;

            const crystalType = crystalOption.dataset.crystal;
            const crystal = crystalConfig[crystalType];
            if (!crystal) return;

            let tooltip = document.querySelector('.mobile-crystal-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'mobile-crystal-tooltip';
                document.body.appendChild(tooltip);
            }

            tooltip.innerHTML = `
                <div class="tooltip-title">${crystal.name}</div>
                <div class="tooltip-category">${crystal.category}è‰²ç³»åˆ—</div>
                <div class="tooltip-description">${crystal.description}</div>
                <div class="tooltip-close">è½»è§¦å…³é—­</div>
            `;

            // è®¾ç½®æ ·å¼
            tooltip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 20px;
                border-radius: 12px;
                max-width: 85vw;
                max-height: 70vh;
                overflow-y: auto;
                z-index: 10002;
                font-size: 14px;
                line-height: 1.4;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                animation: fadeInScale 0.3s ease;
            `;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.querySelector('#mobile-tooltip-styles')) {
                const style = document.createElement('style');
                style.id = 'mobile-tooltip-styles';
                style.textContent = `
                    @keyframes fadeInScale {
                        from {
                            opacity: 0;
                            transform: translate(-50%, -50%) scale(0.8);
                        }
                        to {
                            opacity: 1;
                            transform: translate(-50%, -50%) scale(1);
                        }
                    }
                    .mobile-crystal-tooltip .tooltip-title {
                        font-weight: bold;
                        margin-bottom: 8px;
                        color: #667eea;
                        font-size: 16px;
                    }
                    .mobile-crystal-tooltip .tooltip-category {
                        font-size: 12px;
                        color: #ccc;
                        margin-bottom: 12px;
                    }
                    .mobile-crystal-tooltip .tooltip-description {
                        line-height: 1.5;
                        margin-bottom: 15px;
                    }
                    .mobile-crystal-tooltip .tooltip-close {
                        text-align: center;
                        font-size: 12px;
                        color: #999;
                        border-top: 1px solid #333;
                        padding-top: 10px;
                    }
                `;
                document.head.appendChild(style);
            }

            tooltip.classList.add('show');

            // æ·»åŠ ç‚¹å‡»å…³é—­äº‹ä»¶
            tooltip.addEventListener('touchstart', function (e) {
                e.stopPropagation();
                hideMobileTooltip();
            }, {
                once: true,
                passive: true
            });
        }

        // éšè—ç§»åŠ¨ç«¯tooltip
        function hideMobileTooltip() {
            const tooltip = document.querySelector('.mobile-crystal-tooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 300);
            }
        }

        // æ°´æ™¶æœç´¢åŠŸèƒ½
        function filterCrystals(searchTerm) {
            const categories = document.querySelectorAll('.category-section');
            const searchLower = searchTerm.toLowerCase();

            categories.forEach(category => {
                const crystalOptions = category.querySelectorAll('.crystal-option');
                let hasVisibleCrystals = false;

                crystalOptions.forEach(option => {
                    const crystalName = option.querySelector('div:last-child').textContent
                        .toLowerCase();
                    const isVisible = crystalName.includes(searchLower);
                    option.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) hasVisibleCrystals = true;
                });

                // éšè—æ²¡æœ‰åŒ¹é…ç»“æœçš„åˆ†ç±»
                category.style.display = hasVisibleCrystals ? 'block' : 'none';
            });
        }

        // åŠ¨æ€ç”Ÿæˆæ°´æ™¶é€‰é¡¹HTML
        function generateCrystalOptionsHTML() {
            const categories = {
                'ç´«': {
                    title: 'ğŸ’œ ç´«è‰²ç³»åˆ—',
                    crystals: ['amethyst', 'purple-mica', 'purple-rabbit-hair', 'purple-phantom',
                        'purple-lithium-mica', 'purple-spodumene', 'charoite', 'super-seven'
                    ]
                },
                'ç²‰': {
                    title: 'ğŸŒ¸ ç²‰è‰²ç³»åˆ—',
                    crystals: ['rose-quartz', 'cherry-blossom-agate', 'pink-phantom', 'rhodochrosite',
                        'strawberry-quartz', 'rose-stone'
                    ]
                },
                'ç™½': {
                    title: 'ğŸ¤ ç™½è‰²ç³»åˆ—',
                    crystals: ['clear-quartz', 'milky-quartz', 'pearl', 'white-phantom', 'moonstone', 'white-agate']
                },
                'ç»¿': {
                    title: 'ğŸ’š ç»¿è‰²ç³»åˆ—',
                    crystals: ['amazonite', 'xiuyan-jade', 'green-phantom', 'green-quartz', 'green-fluorite',
                        'prehnite'
                    ]
                },
                'è“': {
                    title: 'ğŸ’™ è“è‰²ç³»åˆ—',
                    crystals: ['labradorite', 'aquamarine', 'kyanite', 'blue-moonstone', 'blue-chalcedony']
                },
                'é»„': {
                    title: 'ğŸ’› é»„è‰²ç³»åˆ—',
                    crystals: ['citrine', 'amber', 'golden-tiger-eye', 'golden-rutilated-quartz',
                        'yellow-tower-crystal', 'yellow-flower-amber', 'yellow-tiger-eye', 'yellow-agate',
                        'black-gold-super'
                    ]
                },
                'çº¢': {
                    title: 'â¤ï¸ çº¢è‰²ç³»åˆ—',
                    crystals: ['garnet', 'cinnabar', 'red-flower-amber']
                },
                'é»‘': {
                    title: 'ğŸ–¤ é»‘è‰²ç³»åˆ—',
                    crystals: ['obsidian', 'venom-stone', 'golden-obsidian', 'silver-obsidian', 'flash-stone',
                        'black-rutilated-quartz', 'black-gold-backbone'
                    ]
                },
                'æ©™': {
                    title: 'ğŸ§¡ æ©™è‰²ç³»åˆ—',
                    crystals: ['sunstone']
                },
                'æ£•': {
                    title: 'ğŸ¤ æ£•è‰²ç³»åˆ—',
                    crystals: ['smoky-quartz']
                },
                'ç°': {
                    title: 'ğŸ©¶ ç°è‰²ç³»åˆ—',
                    crystals: ['gray-rabbit-hair', 'gray-moonstone', 'hawk-eye']
                },
                'å…¶ä»–': {
                    title: 'âœ¨ ç‰¹æ®Šç³»åˆ—',
                    crystals: ['four-season-phantom', 'multi-treasure', 'small-tree-amber', 'sandalwood',
                        'fluorite'
                    ]
                }
            };

            let html = '';
            for (const [categoryKey, categoryData] of Object.entries(categories)) {
                html += `
                    <div class="category-section">
                        <h4 class="category-title">${categoryData.title}</h4>
                        <div class="crystal-types">
                `;

                categoryData.crystals.forEach(crystalType => {
                    const crystal = crystalConfig[crystalType];
                    if (crystal) {
                        html += `
                            <div class="crystal-option" data-crystal="${crystalType}" 
                                 data-crystal-name="${crystal.name}"
                                 data-crystal-description="${crystal.description}">
                                <div class="crystal-image">
                                    <img src="static/ã€${getCrystalColorPrefix(crystalType)}ã€‘${crystal.name}.png" alt="${crystal.name}" />
                                </div>
                                <div>${crystal.name}</div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // ç§»åŠ¨ç«¯é€‚é…ç›¸å…³å‡½æ•°
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                window.innerWidth <= 768;
        }

        function getOptimalCanvasSize() {
            const isMobile = isMobileDevice();
            const screenWidth = window.innerWidth;

            if (screenWidth <= 480) {
                return {
                    width: 250,
                    height: 250
                };
            } else if (screenWidth <= 768) {
                return {
                    width: 300,
                    height: 300
                };
            } else if (screenWidth <= 1024) {
                return {
                    width: 350,
                    height: 350
                };
            } else {
                return {
                    width: 400,
                    height: 400
                };
            }
        }

        function updateCanvasSize() {
            const canvasSize = getOptimalCanvasSize();
            const canvas = document.getElementById('braceletCanvas');
            const container3d = document.getElementById('threejs-container');
            const canvasContainer = document.querySelector('.canvas-container');

            if (canvas) {
                canvas.width = canvasSize.width;
                canvas.height = canvasSize.height;
                canvas.style.width = canvasSize.width + 'px';
                canvas.style.height = canvasSize.height + 'px';
            }

            if (canvasContainer) {
                canvasContainer.style.width = canvasSize.width + 'px';
                canvasContainer.style.height = canvasSize.height + 'px';
            }

            // 3Då®¹å™¨ä½¿ç”¨100%ç»§æ‰¿çˆ¶å®¹å™¨å°ºå¯¸ï¼Œç¡®ä¿å±…ä¸­
            if (container3d) {
                // ä¸è®¾ç½®å›ºå®šå°ºå¯¸ï¼Œè®©å®ƒç»§æ‰¿çˆ¶å®¹å™¨
                container3d.style.width = '100%';
                container3d.style.height = '100%';
            }

            // å¦‚æœ3Dæ¸²æŸ“å™¨å­˜åœ¨ï¼Œæ›´æ–°å…¶å°ºå¯¸
            if (renderer) {
                const borderWidth = 8; // 4px border on each side
                renderer.setSize(canvasSize.width - borderWidth, canvasSize.height - borderWidth);
                if (camera) {
                    camera.aspect = 1; // ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹
                    camera.updateProjectionMatrix();
                }
            }
        }

        // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        function addTouchSupport() {
            let touchStartTime = 0;
            let longPressTimer = null;
            let currentTooltipTarget = null;

            // ä¸ºæ°´æ™¶é€‰æ‹©æ·»åŠ è§¦æ‘¸åé¦ˆ
            document.addEventListener('touchstart', function (e) {
                const target = e.target.closest(
                    '.crystal-option, .option-btn, .view-btn, .download-btn, .generate-btn, .count-btn, .auto-calc-btn'
                );
                if (target) {
                    target.classList.add('mobile-pressed');
                    touchStartTime = Date.now();

                    // å¦‚æœæ˜¯æ°´æ™¶é€‰é¡¹ï¼Œè®¾ç½®é•¿æŒ‰æ˜¾ç¤ºtooltip
                    if (target.classList.contains('crystal-option')) {
                        currentTooltipTarget = target;
                        longPressTimer = setTimeout(() => {
                            showMobileTooltip(target, e);
                        }, 500); // é•¿æŒ‰500msæ˜¾ç¤ºtooltip
                    }
                }
            }, {
                passive: true
            });

            document.addEventListener('touchmove', function (e) {
                // ç§»åŠ¨æ—¶å–æ¶ˆé•¿æŒ‰
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                hideMobileTooltip();
            }, {
                passive: true
            });

            document.addEventListener('touchend', function (e) {
                const target = e.target.closest(
                    '.crystal-option, .option-btn, .view-btn, .download-btn, .generate-btn, .count-btn, .auto-calc-btn'
                );
                if (target) {
                    setTimeout(() => {
                        target.classList.remove('mobile-pressed');
                    }, 150);
                }

                // æ¸…é™¤é•¿æŒ‰å®šæ—¶å™¨
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // çŸ­æŒ‰æ—¶éšè—tooltip
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 500) {
                    hideMobileTooltip();
                }

                currentTooltipTarget = null;
            }, {
                passive: true
            });

            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            document.addEventListener('touchstart', function (e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, {
                passive: false
            });

            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—tooltip
            document.addEventListener('touchstart', function (e) {
                if (!e.target.closest('.crystal-option') && !e.target.closest('.crystal-tooltip')) {
                    hideMobileTooltip();
                }
            }, {
                passive: true
            });
        }

        // ä¼˜åŒ–ç§»åŠ¨ç«¯æ°´æ™¶é€‰æ‹©é¢æ¿
        function optimizeMobilePalette() {
            const palette = document.querySelector('.crystal-palette');
            if (!palette) return;

            // ç§»åŠ¨ç«¯æ—¶è°ƒæ•´é¢æ¿å¤§å°
            if (isMobileDevice()) {
                const screenHeight = window.innerHeight;
                const maxHeight = Math.min(screenHeight * 0.9, 600);
                palette.style.maxHeight = maxHeight + 'px';

                const categories = palette.querySelector('.crystal-categories');
                if (categories) {
                    categories.style.maxHeight = (maxHeight - 120) + 'px';
                }
            }
        }

        // å¤„ç†å±å¹•æ–¹å‘å˜åŒ–
        function handleOrientationChange() {
            setTimeout(() => {
                updateCanvasSize();
                optimizeMobilePalette();

                // å¦‚æœæ˜¯3Dè§†å›¾ï¼Œè°ƒæ•´æ¸²æŸ“å™¨å°ºå¯¸
                if (currentView === '3d') {
                    resize3DRenderer();
                }

                if (currentView === '2d' && beadConfigs.length > 0) {
                    generateBracelet2D();
                } else if (currentView === '3d' && beadConfigs.length > 0) {
                    generate3DBracelet();
                }
            }, 300);
        }

        // ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨
        function optimizeMobileScrolling() {
            // ä¸ºç å­åˆ—è¡¨æ·»åŠ åŠ¨é‡æ»šåŠ¨
            const beadList = document.getElementById('bead-list');
            if (beadList && isMobileDevice()) {
                beadList.style.webkitOverflowScrolling = 'touch';
                beadList.style.overflowScrolling = 'touch';
            }

            // ä¸ºæ°´æ™¶åˆ†ç±»æ·»åŠ åŠ¨é‡æ»šåŠ¨
            const crystalCategories = document.querySelector('.crystal-categories');
            if (crystalCategories && isMobileDevice()) {
                crystalCategories.style.webkitOverflowScrolling = 'touch';
                crystalCategories.style.overflowScrolling = 'touch';
            }
        }

        // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
        function optimizeMobilePerformance() {
            if (isMobileDevice()) {
                // å‡å°‘åŠ¨ç”»å¤æ‚åº¦
                document.documentElement.style.setProperty('--animation-duration', '0.2s');

                // ä¼˜åŒ–å›¾ç‰‡åŠ è½½
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                    img.loading = 'lazy';
                });

                // æ˜¾ç¤ºç§»åŠ¨ç«¯ä½¿ç”¨æç¤º
                showMobileUsageTip();
            }
        }

        // æ˜¾ç¤ºç§»åŠ¨ç«¯ä½¿ç”¨æç¤º
        function showMobileUsageTip() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡æç¤º
            if (localStorage.getItem('mobile-tip-shown')) {
                return;
            }

            setTimeout(() => {
                const tip = document.createElement('div');
                tip.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 10px;
                    right: 10px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px;
                    border-radius: 12px;
                    z-index: 10003;
                    font-size: 13px;
                    text-align: center;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideDown 0.5s ease;
                `;

                tip.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px;">ğŸ“± ç§»åŠ¨ç«¯ä½¿ç”¨æç¤º</div>
                    <div style="margin-bottom: 8px;">â€¢ é•¿æŒ‰æ°´æ™¶æŸ¥çœ‹è¯¦ç»†ä»‹ç»</div>
                    <div style="margin-bottom: 8px;">â€¢ 3Dè§†å›¾æ”¯æŒè§¦æ‘¸æ—‹è½¬å’ŒåŒæŒ‡ç¼©æ”¾</div>
                    <div style="font-size: 11px; opacity: 0.8; cursor: pointer;" onclick="this.parentNode.remove(); localStorage.setItem('mobile-tip-shown', 'true');">
                        è½»è§¦å…³é—­
                    </div>
                `;

                // æ·»åŠ åŠ¨ç”»æ ·å¼
                if (!document.querySelector('#mobile-tip-styles')) {
                    const style = document.createElement('style');
                    style.id = 'mobile-tip-styles';
                    style.textContent = `
                        @keyframes slideDown {
                            from {
                                opacity: 0;
                                transform: translateY(-20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(tip);

                // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.style.animation = 'slideDown 0.3s ease reverse';
                        setTimeout(() => {
                            if (tip.parentNode) {
                                tip.parentNode.removeChild(tip);
                            }
                        }, 300);
                    }
                    localStorage.setItem('mobile-tip-shown', 'true');
                }, 5000);
            }, 2000);
        }

        // è°ƒæ•´3Dæ¸²æŸ“å™¨å°ºå¯¸
        function resize3DRenderer() {
            if (!renderer) return;

            const container = document.getElementById('threejs-container');
            if (!container) return;

            // ç­‰å¾…DOMæ›´æ–°åå†è·å–å°ºå¯¸
            setTimeout(() => {
                const containerRect = container.getBoundingClientRect();
                if (containerRect.width > 0 && containerRect.height > 0) {
                    const borderWidth = 8; // 4px border on each side
                    const renderWidth = containerRect.width - borderWidth;
                    const renderHeight = containerRect.height - borderWidth;

                    renderer.setSize(renderWidth, renderHeight);
                    if (camera) {
                        camera.aspect = 1; // ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹
                        camera.updateProjectionMatrix();
                    }

                    console.log(`3Dæ¸²æŸ“å™¨å°ºå¯¸å·²è°ƒæ•´: ${renderWidth}x${renderHeight}`);
                }
            }, 50);
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function () {
            // åŠ¨æ€ç”Ÿæˆæ°´æ™¶é€‰é¡¹
            const categoriesContainer = document.querySelector('.crystal-categories');
            if (categoriesContainer) {
                categoriesContainer.innerHTML = generateCrystalOptionsHTML();
            }

            // åœˆå£é€‰æ‹©
            document.querySelectorAll('[data-circumference]').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('[data-circumference]').forEach(opt => opt
                        .classList.remove('selected'));
                    this.classList.add('selected');
                    selectedCircumference = parseInt(this.dataset.circumference);
                    updateInfo();
                });
            });

            // ç»Ÿä¸€å°ºå¯¸é€‰æ‹©
            document.querySelectorAll('[data-size]').forEach(option => {
                option.addEventListener('click', function () {
                    document.querySelectorAll('[data-size]').forEach(opt => opt
                        .classList.remove('selected'));
                    this.classList.add('selected');
                    updateUniformBeadSize(this.dataset.size);
                });
            });

            // æ°´æ™¶é€‰æ‹©ï¼ˆåœ¨å¼¹çª—ä¸­ï¼‰- ä½¿ç”¨äº‹ä»¶å§”æ‰˜
            document.addEventListener('click', function (e) {
                if (e.target.closest('.crystal-option')) {
                    const crystalOption = e.target.closest('.crystal-option');
                    if (currentEditingBead !== null) {
                        const crystalType = crystalOption.dataset.crystal;
                        beadConfigs[currentEditingBead].crystal = crystalType;
                        updateBeadList();
                        closeCrystalPalette();
                        generateBracelet();
                    }
                }
            });

            // æœç´¢åŠŸèƒ½
            document.addEventListener('input', function (e) {
                if (e.target.id === 'crystal-search') {
                    filterCrystals(e.target.value);
                }
            });

            // åˆå§‹åŒ–
            initializeBeads();
            document.querySelector('[data-circumference="15"]').click();

            // ç§»åŠ¨ç«¯ä¼˜åŒ–åˆå§‹åŒ–
            updateCanvasSize();
            addTouchSupport();
            optimizeMobileScrolling();
            optimizeMobilePerformance();
            optimizeMobilePalette();

            // æ·»åŠ çª—å£å¤§å°å˜åŒ–ç›‘å¬
            window.addEventListener('resize', handleOrientationChange);
            window.addEventListener('orientationchange', handleOrientationChange);

            // æ£€æŸ¥Three.jsåŠ è½½çŠ¶æ€
            setTimeout(() => {
                if (typeof THREE !== 'undefined') {
                    console.log('âœ… Three.jsåŠ è½½æˆåŠŸ');
                    if (typeof THREE.OrbitControls !== 'undefined') {
                        console.log('âœ… OrbitControlsåŠ è½½æˆåŠŸ');
                    } else {
                        console.warn('âš ï¸ OrbitControlsæœªåŠ è½½');
                    }
                } else {
                    console.error('âŒ Three.jsåŠ è½½å¤±è´¥');
                }
            }, 1000);
        });

        function updateInfo() {
            // ä¿ç•™åŸºæœ¬çš„ä¿¡æ¯æ›´æ–°é€»è¾‘ï¼Œä½†ä¸æ›´æ–°UIæ˜¾ç¤º
            // è¿™äº›è®¡ç®—å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹éœ€è¦ç”¨åˆ°
        }



        // å›¾ç‰‡ç¼“å­˜
        const imageCache = new Map();
        // 3Dçº¹ç†ç¼“å­˜
        const textureCache = new Map();

        // é¢„åŠ è½½å›¾ç‰‡
        function preloadImage(src) {
            return new Promise((resolve, reject) => {
                if (imageCache.has(src)) {
                    resolve(imageCache.get(src));
                    return;
                }

                const img = new Image();
                img.onload = () => {
                    imageCache.set(src, img);
                    resolve(img);
                };
                img.onerror = reject;
                img.src = src;
            });
        }

        // è·å–ç å­å›¾ç‰‡è·¯å¾„
        function getBeadImagePath(crystalType) {
            const crystal = crystalConfig[crystalType];
            const colorPrefix = getCrystalColorPrefix(crystalType);
            return `static/ã€${colorPrefix}ã€‘${crystal.name}.png`;
        }



        // 3Dè§†å›¾ç›¸å…³å‡½æ•°

        // 3Dè§†å›¾ç›¸å…³å‡½æ•°
        function init3D() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–3Dåœºæ™¯...');

                // æ£€æŸ¥Three.jsæ˜¯å¦åŠ è½½
                if (typeof THREE === 'undefined') {
                    console.error('Three.jsæœªåŠ è½½');
                    return false;
                }

                const container = document.getElementById('threejs-container');
                if (!container) {
                    console.error('æ‰¾ä¸åˆ°3Då®¹å™¨å…ƒç´ ');
                    return false;
                }

                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';

                // åˆ›å»ºåœºæ™¯
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf8f9fa);

                // åˆ›å»ºç›¸æœº
                camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                camera.position.set(0, 0, 150);

                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                });

                // åŠ¨æ€è®¡ç®—æ¸²æŸ“å™¨å°ºå¯¸
                const containerRect = container.getBoundingClientRect();
                const borderWidth = 8; // 4px border on each side
                const renderWidth = containerRect.width - borderWidth;
                const renderHeight = containerRect.height - borderWidth;

                renderer.setSize(renderWidth, renderHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                // å…¼å®¹æ€§å¤„ç†
                if (renderer.outputEncoding !== undefined) {
                    renderer.outputEncoding = THREE.sRGBEncoding;
                }
                if (renderer.toneMapping !== undefined) {
                    renderer.toneMapping = THREE.ACESFilmicToneMapping;
                    renderer.toneMappingExposure = 1.2;
                }

                container.appendChild(renderer.domElement);

                // æ·»åŠ è½¨é“æ§åˆ¶å™¨
                if (typeof THREE.OrbitControls !== 'undefined') {
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    controls.enableZoom = true;
                    controls.enablePan = false;
                    controls.minDistance = 80;
                    controls.maxDistance = 300;

                    // ç§»åŠ¨ç«¯ä¼˜åŒ–
                    if (isMobileDevice()) {
                        controls.enableZoom = true;
                        controls.zoomSpeed = 0.8;
                        controls.rotateSpeed = 0.8;
                        controls.dampingFactor = 0.1;
                        controls.enableDamping = true;
                        controls.touches = {
                            ONE: THREE.TOUCH.ROTATE,
                            TWO: THREE.TOUCH.DOLLY_PAN
                        };
                    }
                } else {
                    console.warn('OrbitControlsæœªåŠ è½½ï¼Œå°†ä½¿ç”¨åŸºæœ¬ç›¸æœºæ§åˆ¶');
                    // æ·»åŠ åŸºæœ¬çš„é¼ æ ‡æ§åˆ¶
                    addBasicControls(camera, renderer.domElement);
                }

                // æ·»åŠ å…‰æº
                setupLighting();

                // åˆ›å»ºæ‰‹é“¾ç»„
                braceletGroup = new THREE.Group();
                scene.add(braceletGroup);

                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                animate3D();

                console.log('3Dåœºæ™¯åˆå§‹åŒ–æˆåŠŸ');
                return true;

            } catch (error) {
                console.error('3Dåˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // ä¸»å…‰æº
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -100;
            directionalLight.shadow.camera.right = 100;
            directionalLight.shadow.camera.top = 100;
            directionalLight.shadow.camera.bottom = -100;
            scene.add(directionalLight);

            // è¡¥å…‰
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-50, -50, 50);
            scene.add(fillLight);

            // é¡¶å…‰
            const topLight = new THREE.DirectionalLight(0xffffff, 0.4);
            topLight.position.set(0, 100, 0);
            scene.add(topLight);

            // æ·»åŠ ç‚¹å…‰æºå¢å¼ºç å­å…‰æ³½
            const pointLight1 = new THREE.PointLight(0xffffff, 0.5, 200);
            pointLight1.position.set(100, 100, 100);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xffffff, 0.3, 200);
            pointLight2.position.set(-100, -100, 100);
            scene.add(pointLight2);
        }

        function animate3D() {
            requestAnimationFrame(animate3D);

            if (controls) {
                controls.update();
            }

            // ç¼“æ…¢æ—‹è½¬æ‰‹é“¾
            if (braceletGroup) {
                braceletGroup.rotation.y += 0.005;
            }

            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // é¢„åŠ è½½3Dçº¹ç†
        function preload3DTextures() {
            const uniqueCrystals = [...new Set(beadConfigs.map(bead => bead.crystal))];
            const textureLoader = new THREE.TextureLoader();

            console.log(`å¼€å§‹é¢„åŠ è½½ ${uniqueCrystals.length} ç§æ°´æ™¶çº¹ç†...`);

            uniqueCrystals.forEach(crystalType => {
                const imagePath = getBeadImagePath(crystalType);
                const crystal = crystalConfig[crystalType];

                if (!textureCache.has(imagePath)) {
                    textureLoader.load(
                        imagePath,
                        function (texture) {
                            // æè‡´ä¼˜åŒ–çº¹ç†è®¾ç½®
                            texture.wrapS = THREE.ClampToEdgeWrapping;
                            texture.wrapT = THREE.ClampToEdgeWrapping;
                            texture.repeat.set(1, 1);
                            texture.offset.set(0, 0);
                            texture.center.set(0.5, 0.5);
                            texture.rotation = 0;
                            texture.minFilter = THREE.LinearMipmapLinearFilter;
                            texture.magFilter = THREE.LinearFilter;
                            texture.generateMipmaps = true;
                            texture.flipY = false;
                            texture.premultiplyAlpha = false;
                            texture.unpackAlignment = 4;

                            textureCache.set(imagePath, texture);
                            console.log(`âœ… é¢„åŠ è½½çº¹ç†æˆåŠŸ: ${crystal.name}`);
                        },
                        function (progress) {
                            // åŠ è½½è¿›åº¦
                        },
                        function (error) {
                            console.warn(`âš ï¸ é¢„åŠ è½½çº¹ç†å¤±è´¥: ${crystal.name}`);
                        }
                    );
                }
            });
        }

        function generate3DBracelet() {
            if (!scene) {
                console.error('3Dåœºæ™¯æœªåˆå§‹åŒ–');
                return;
            }

            if (beadConfigs.length === 0) {
                console.warn('æ²¡æœ‰ç å­é…ç½®');
                // åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç«‹æ–¹ä½“
                createTestCube();
                return;
            }

            // é¢„åŠ è½½çº¹ç†
            preload3DTextures();

            // æ¸…é™¤ç°æœ‰çš„æ‰‹é“¾
            while (braceletGroup.children.length > 0) {
                braceletGroup.remove(braceletGroup.children[0]);
            }

            // è®¡ç®—æ‰‹é“¾å‚æ•°
            const circumferenceInMm = selectedCircumference * 10;
            const totalBeadDiameter = beadConfigs.reduce((sum, bead) => sum + bead.size, 0);
            const availableSpace = circumferenceInMm - totalBeadDiameter;
            const minSpacing = 0.5;
            const calculatedSpacing = availableSpace / currentBeadCount;
            const spacing = Math.max(minSpacing, calculatedSpacing);

            let adjustedCircumference = circumferenceInMm;
            if (calculatedSpacing < minSpacing) {
                adjustedCircumference = totalBeadDiameter + (currentBeadCount * minSpacing);
            }

            const radius = adjustedCircumference / (2 * Math.PI);

            // åˆ›å»ºç å­
            for (let i = 0; i < currentBeadCount; i++) {
                const beadConfig = beadConfigs[i];
                const crystal = crystalConfig[beadConfig.crystal];

                // è®¡ç®—ä½ç½®
                const angle = (i / currentBeadCount) * Math.PI * 2;
                const x = radius * Math.cos(angle);
                const z = radius * Math.sin(angle);
                const y = 0;

                // åˆ›å»ºä¼˜åŒ–çš„ç å­å‡ ä½•ä½“
                const beadRadius = beadConfig.size / 2;
                const geometry = createOptimizedSphereGeometry(beadRadius);

                // åˆ›å»ºæè´¨ï¼ˆä¼ å…¥crystalTypeç”¨äºåŠ è½½å¯¹åº”å›¾ç‰‡ï¼‰
                const material = createBeadMaterial(crystal, beadConfig.crystal);

                // åˆ›å»ºç å­ç½‘æ ¼
                const bead = new THREE.Mesh(geometry, material);
                bead.position.set(x, y, z);
                bead.castShadow = true;
                bead.receiveShadow = true;

                braceletGroup.add(bead);

                // åˆ›å»ºè¿æ¥çº¿
                if (i < currentBeadCount - 1 || currentBeadCount > 2) {
                    const nextIndex = (i + 1) % currentBeadCount;
                    const nextAngle = (nextIndex / currentBeadCount) * Math.PI * 2;
                    const nextX = radius * Math.cos(nextAngle);
                    const nextZ = radius * Math.sin(nextAngle);

                    createConnectionString(x, y, z, nextX, y, nextZ, beadRadius);
                }
            }

            // æ·»åŠ åº•åº§é˜´å½±
            createShadowPlane();
        }

        function createBeadMaterial(crystal, crystalType) {
            // æ ¹æ®æ°´æ™¶ç±»å‹åˆ›å»ºä¸åŒçš„æè´¨
            const baseColor = new THREE.Color(crystal.color);

            // åŠ è½½æ°´æ™¶å›¾ç‰‡ä½œä¸ºçº¹ç†
            const imagePath = getBeadImagePath(crystalType);

            // åˆ›å»ºå¸¦çº¹ç†çš„æè´¨é…ç½®
            const materialConfig = {
                color: baseColor,
                shininess: 80,
                specular: 0x111111
            };

            // æ ¹æ®æ°´æ™¶ç±»å‹è°ƒæ•´æè´¨å±æ€§
            if (crystal.category === 'é»‘') {
                // é»‘è‰²æ°´æ™¶ - é«˜åå°„
                materialConfig.shininess = 100;
                materialConfig.specular = 0x444444;
                materialConfig.combine = THREE.MixOperation;
                materialConfig.reflectivity = 0.8;
            } else if (crystal.category === 'ç™½') {
                // ç™½è‰²æ°´æ™¶ - é€æ˜æ„Ÿ
                materialConfig.opacity = 0.85;
                materialConfig.transparent = true;
                materialConfig.shininess = 120;
                materialConfig.specular = 0xffffff;
                materialConfig.combine = THREE.MixOperation;
                materialConfig.reflectivity = 0.9;
            } else {
                // å½©è‰²æ°´æ™¶ - å®çŸ³è´¨æ„Ÿ
                materialConfig.opacity = 0.95;
                materialConfig.transparent = true;
                materialConfig.shininess = 90;
                materialConfig.specular = 0x222222;
                materialConfig.combine = THREE.MixOperation;
                materialConfig.reflectivity = 0.7;
            }

            // ä¼˜åŒ–æè´¨è®¾ç½®
            materialConfig.side = THREE.FrontSide;
            materialConfig.vertexColors = false;
            materialConfig.fog = true;
            materialConfig.alphaTest = 0.01;

            const material = new THREE.MeshPhongMaterial(materialConfig);

            // æ£€æŸ¥çº¹ç†ç¼“å­˜
            if (textureCache.has(imagePath)) {
                // ä½¿ç”¨ç¼“å­˜çš„çº¹ç†
                const cachedTexture = textureCache.get(imagePath);
                const processedTexture = preprocessTexture(cachedTexture);
                material.map = processedTexture;
                material.needsUpdate = true;
                console.log(`ğŸ”„ ä½¿ç”¨ç¼“å­˜çº¹ç†: ${crystal.name}`);
            } else {
                // åŠ è½½æ–°çº¹ç†
                const textureLoader = new THREE.TextureLoader();
                textureLoader.load(
                    imagePath,
                    function (texture) {
                        // çº¹ç†åŠ è½½æˆåŠŸï¼Œæè‡´ä¼˜åŒ–çº¹ç†è®¾ç½®
                        texture.wrapS = THREE.ClampToEdgeWrapping;
                        texture.wrapT = THREE.ClampToEdgeWrapping;
                        texture.repeat.set(1, 1);
                        texture.offset.set(0, 0);
                        texture.center.set(0.5, 0.5);
                        texture.rotation = 0;
                        texture.minFilter = THREE.LinearMipmapLinearFilter;
                        texture.magFilter = THREE.LinearFilter;
                        texture.generateMipmaps = true;
                        texture.flipY = false;
                        texture.premultiplyAlpha = false;
                        texture.unpackAlignment = 4;

                        // ç¼“å­˜çº¹ç†
                        textureCache.set(imagePath, texture);

                        // é¢„å¤„ç†å¹¶åº”ç”¨çº¹ç†
                        const processedTexture = preprocessTexture(texture);
                        material.map = processedTexture;
                        material.needsUpdate = true;

                        console.log(`âœ… çº¹ç†åŠ è½½æˆåŠŸ: ${crystal.name}`);
                    },
                    function (progress) {
                        // åŠ è½½è¿›åº¦
                    },
                    function (error) {
                        // çº¹ç†åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²
                        console.warn(`âš ï¸ çº¹ç†åŠ è½½å¤±è´¥: ${crystal.name}, ä½¿ç”¨çº¯è‰²æ›¿ä»£`);
                    }
                );
            }

            return material;
        }

        function createConnectionString(x1, y1, z1, x2, y2, z2, beadRadius) {
            // è®¡ç®—è¿æ¥ç‚¹
            const direction = new THREE.Vector3(x2 - x1, y2 - y1, z2 - z1).normalize();
            const startPoint = new THREE.Vector3(x1, y1, z1).add(direction.clone().multiplyScalar(beadRadius));
            const endPoint = new THREE.Vector3(x2, y2, z2).sub(direction.clone().multiplyScalar(beadRadius));

            // åˆ›å»ºå¼¹åŠ›ç»³å‡ ä½•ä½“
            const points = [startPoint, endPoint];
            const geometry = new THREE.BufferGeometry().setFromPoints(points);

            // å¼¹åŠ›ç»³æè´¨
            const material = new THREE.LineBasicMaterial({
                color: 0xdcdcff,
                transparent: true,
                opacity: 0.8,
                linewidth: 3
            });

            const line = new THREE.Line(geometry, material);
            braceletGroup.add(line);
        }

        function createShadowPlane() {
            // åˆ›å»ºæ¥æ”¶é˜´å½±çš„å¹³é¢
            const planeGeometry = new THREE.PlaneGeometry(200, 200);
            const planeMaterial = new THREE.ShadowMaterial({
                opacity: 0.2
            });

            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = -50;
            plane.receiveShadow = true;

            scene.add(plane);
        }

        function createTestCube() {
            // æ¸…é™¤ç°æœ‰å¯¹è±¡
            while (braceletGroup.children.length > 0) {
                braceletGroup.remove(braceletGroup.children[0]);
            }

            // åˆ›å»ºæµ‹è¯•ç«‹æ–¹ä½“
            const geometry = new THREE.BoxGeometry(20, 20, 20);
            const material = new THREE.MeshPhongMaterial({
                color: 0x667eea
            });
            const cube = new THREE.Mesh(geometry, material);
            cube.castShadow = true;
            cube.receiveShadow = true;

            braceletGroup.add(cube);
            console.log('åˆ›å»ºäº†æµ‹è¯•ç«‹æ–¹ä½“');
        }

        function addBasicControls(camera, domElement) {
            let isMouseDown = false;
            let mouseX = 0,
                mouseY = 0;
            let targetRotationX = 0,
                targetRotationY = 0;
            let rotationX = 0,
                rotationY = 0;

            domElement.addEventListener('mousedown', function (event) {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            domElement.addEventListener('mousemove', function (event) {
                if (!isMouseDown) return;

                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;

                targetRotationY += deltaX * 0.01;
                targetRotationX += deltaY * 0.01;

                mouseX = event.clientX;
                mouseY = event.clientY;
            });

            domElement.addEventListener('mouseup', function () {
                isMouseDown = false;
            });

            // å¹³æ»‘æ—‹è½¬
            function updateCamera() {
                rotationX += (targetRotationX - rotationX) * 0.1;
                rotationY += (targetRotationY - rotationY) * 0.1;

                const radius = 150;
                camera.position.x = radius * Math.sin(rotationY) * Math.cos(rotationX);
                camera.position.y = radius * Math.sin(rotationX);
                camera.position.z = radius * Math.cos(rotationY) * Math.cos(rotationX);
                camera.lookAt(0, 0, 0);

                requestAnimationFrame(updateCamera);
            }
            updateCamera();
        }

        // åˆ›å»ºä¼˜åŒ–çš„çƒä½“å‡ ä½•ä½“ï¼Œç¡®ä¿çº¹ç†å®Œç¾è¦†ç›–
        function createOptimizedSphereGeometry(radius) {
            const widthSegments = 64;
            const heightSegments = 64;

            const geometry = new THREE.SphereGeometry(radius, widthSegments, heightSegments);

            // é«˜çº§UVæ˜ å°„ä¼˜åŒ–
            const uvAttribute = geometry.attributes.uv;
            const positionAttribute = geometry.attributes.position;
            const uvArray = uvAttribute.array;
            const positionArray = positionAttribute.array;

            for (let i = 0; i < uvArray.length; i += 2) {
                const vertexIndex = i / 2;
                const x = positionArray[vertexIndex * 3];
                const y = positionArray[vertexIndex * 3 + 1];
                const z = positionArray[vertexIndex * 3 + 2];

                // çƒé¢åæ ‡è½¬UVï¼Œç¡®ä¿å®Œç¾è¦†ç›–
                const phi = Math.atan2(z, x);
                const theta = Math.acos(y / radius);

                let u = (phi + Math.PI) / (2 * Math.PI);
                let v = theta / Math.PI;

                // ä¿®æ­£UVåæ ‡ï¼Œç¡®ä¿å®Œå…¨è¦†ç›–
                u = Math.max(0.001, Math.min(0.999, u));
                v = Math.max(0.001, Math.min(0.999, v));

                uvArray[i] = u;
                uvArray[i + 1] = v;
            }

            uvAttribute.needsUpdate = true;
            geometry.computeBoundingSphere();

            return geometry;
        }

        // çº¹ç†é¢„å¤„ç†å‡½æ•°ï¼Œç¡®ä¿å®Œç¾è´´åˆ
        function preprocessTexture(texture) {
            // åˆ›å»ºcanvasè¿›è¡Œçº¹ç†é¢„å¤„ç†
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // è®¾ç½®canvaså°ºå¯¸ä¸º2çš„å¹‚æ¬¡æ–¹ï¼Œç¡®ä¿æœ€ä½³æ€§èƒ½
            const size = 512;
            canvas.width = size;
            canvas.height = size;

            // ç»˜åˆ¶åŸå§‹å›¾ç‰‡åˆ°canvasï¼Œç¡®ä¿å®Œå…¨å¡«å……
            const img = texture.image;
            if (img && img.complete) {
                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œç¡®ä¿å›¾ç‰‡å®Œå…¨è¦†ç›–canvas
                const scale = Math.max(size / img.width, size / img.height);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;

                // å±…ä¸­ç»˜åˆ¶
                const offsetX = (size - scaledWidth) / 2;
                const offsetY = (size - scaledHeight) / 2;

                ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);

                // æ·»åŠ è¾¹ç¼˜å¡«å……ï¼Œé¿å…çº¹ç†è¾¹ç¼˜é—®é¢˜
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = getAverageColor(ctx, size, size);
                ctx.fillRect(0, 0, size, size);

                // åˆ›å»ºæ–°çš„çº¹ç†
                const processedTexture = new THREE.CanvasTexture(canvas);

                // åº”ç”¨åŸå§‹çº¹ç†çš„è®¾ç½®
                processedTexture.wrapS = texture.wrapS;
                processedTexture.wrapT = texture.wrapT;
                processedTexture.repeat.copy(texture.repeat);
                processedTexture.offset.copy(texture.offset);
                processedTexture.center.copy(texture.center);
                processedTexture.rotation = texture.rotation;
                processedTexture.minFilter = texture.minFilter;
                processedTexture.magFilter = texture.magFilter;
                processedTexture.generateMipmaps = texture.generateMipmaps;
                processedTexture.flipY = texture.flipY;
                processedTexture.premultiplyAlpha = texture.premultiplyAlpha;
                processedTexture.unpackAlignment = texture.unpackAlignment;

                return processedTexture;
            }

            return texture;
        }

        // è·å–å›¾åƒå¹³å‡é¢œè‰²ï¼Œç”¨äºè¾¹ç¼˜å¡«å……
        function getAverageColor(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            let r = 0,
                g = 0,
                b = 0;
            let count = 0;

            // é‡‡æ ·è¾¹ç¼˜åƒç´ 
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) { // åªè®¡ç®—éé€æ˜åƒç´ 
                    r += data[i];
                    g += data[i + 1];
                    b += data[i + 2];
                    count++;
                }
            }

            if (count > 0) {
                r = Math.round(r / count);
                g = Math.round(g / count);
                b = Math.round(b / count);
                return `rgb(${r}, ${g}, ${b})`;
            }

            return '#f0f0f0'; // é»˜è®¤æµ…ç°è‰²
        }

        // ä¸‹è½½2Dæ•ˆæœå›¾åŠŸèƒ½
        function download2DImage() {
            if (beadConfigs.length === 0) {
                alert('è¯·å…ˆé…ç½®ç å­å¹¶ç”Ÿæˆæ‰‹é“¾é¢„è§ˆ');
                return;
            }

            // åˆ›å»ºé«˜åˆ†è¾¨ç‡ç”»å¸ƒç”¨äºä¸‹è½½
            const downloadCanvas = document.createElement('canvas');
            const downloadCtx = downloadCanvas.getContext('2d');

            // è®¾ç½®é«˜åˆ†è¾¨ç‡å°ºå¯¸ (2å€åˆ†è¾¨ç‡)
            const scale = 2;
            const width = 800;
            const height = 800;
            downloadCanvas.width = width * scale;
            downloadCanvas.height = height * scale;

            // ç¼©æ”¾ä¸Šä¸‹æ–‡ä»¥è·å¾—é«˜åˆ†è¾¨ç‡
            downloadCtx.scale(scale, scale);

            // ç”Ÿæˆé«˜è´¨é‡çš„2Dæ‰‹é“¾å›¾åƒ
            generateBracelet2DToCanvas(downloadCtx, width, height).then(() => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');

                // ç”Ÿæˆæ–‡ä»¶å
                const crystalTypes = [...new Set(beadConfigs.map(bead => bead.crystal))];
                let filename = 'æ°´æ™¶æ‰‹é“¾è®¾è®¡';

                if (crystalTypes.length === 1) {
                    const crystal = crystalConfig[crystalTypes[0]];
                    filename = `${crystal.name}æ‰‹é“¾_${currentBeadCount}é¢—_${selectedCircumference}cm`;
                } else {
                    filename = `${crystalTypes.length}ç§æ°´æ™¶æ‰‹é“¾_${currentBeadCount}é¢—_${selectedCircumference}cm`;
                }

                // æ·»åŠ æ—¶é—´æˆ³
                const now = new Date();
                const timestamp = now.getFullYear() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') + '_' +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0');

                filename += `_${timestamp}.png`;

                // è®¾ç½®ä¸‹è½½å±æ€§
                link.download = filename;
                link.href = downloadCanvas.toDataURL('image/png', 1.0);

                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log(`âœ… ä¸‹è½½å®Œæˆ: ${filename}`);

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showDownloadSuccess(filename);
            }).catch(error => {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // æ˜¾ç¤ºä¸‹è½½æˆåŠŸæç¤º
        function showDownloadSuccess(filename) {
            const toast = document.createElement('div');
            const isMobile = isMobileDevice();

            toast.style.cssText = `
                position: fixed;
                ${isMobile ? 'top: 10px; left: 10px; right: 10px;' : 'top: 20px; right: 20px;'}
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: ${isMobile ? '13px' : '14px'};
                ${isMobile ? '' : 'max-width: 300px;'}
                word-break: break-all;
                text-align: center;
            `;
            toast.innerHTML = `âœ… ä¸‹è½½æˆåŠŸ<br><small>${filename}</small>`;

            document.body.appendChild(toast);

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // æ˜¾ç¤ºç§»åŠ¨ç«¯åŠ è½½æç¤º
        function showMobileLoadingTip(message) {
            if (!isMobileDevice()) return;

            const tip = document.createElement('div');
            tip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 10001;
                font-size: 14px;
                text-align: center;
                max-width: 80vw;
            `;
            tip.innerHTML = message;

            document.body.appendChild(tip);

            return tip;
        }

        // éšè—ç§»åŠ¨ç«¯åŠ è½½æç¤º
        function hideMobileLoadingTip(tip) {
            if (tip && tip.parentNode) {
                tip.parentNode.removeChild(tip);
            }
        }

        // è§†å›¾åˆ‡æ¢å‡½æ•°
        function switchView(viewType) {
            currentView = viewType;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°ä¸‹è½½æŒ‰é’®çŠ¶æ€
            const downloadSection = document.querySelector('.download-section');
            const downloadBtn = document.querySelector('.download-btn');
            if (downloadSection && downloadBtn) {
                downloadSection.style.display = (viewType === '2d') ? 'block' : 'none';
                downloadBtn.disabled = (viewType !== '2d');
            }

            const canvas2d = document.getElementById('braceletCanvas');
            const container3d = document.getElementById('threejs-container');
            const instructions = document.getElementById('view-instructions');

            if (viewType === '2d') {
                canvas2d.style.display = 'block';
                container3d.style.display = 'none';
                instructions.textContent = 'ç‚¹å‡»"ç”Ÿæˆæ‰‹é“¾é¢„è§ˆ"æŸ¥çœ‹æ•ˆæœ';
            } else {
                canvas2d.style.display = 'none';
                container3d.style.display = 'block';

                // æ£€æŸ¥Three.jsæ˜¯å¦å¯ç”¨
                if (typeof THREE === 'undefined') {
                    instructions.innerHTML = 'âŒ åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
                    console.error('Three.jsæœªåŠ è½½');
                    return;
                }

                instructions.textContent = 'åˆå§‹åŒ–ä¸­...';

                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²å‡†å¤‡å¥½
                setTimeout(() => {
                    // åˆå§‹åŒ–3Dåœºæ™¯ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
                    if (!renderer) {
                        const success = init3D();
                        if (!success) {
                            instructions.innerHTML = 'âŒ åˆå§‹åŒ–å¤±è´¥';
                            return;
                        }
                    } else {
                        // å¦‚æœæ¸²æŸ“å™¨å·²å­˜åœ¨ï¼Œè°ƒæ•´å°ºå¯¸ä»¥é€‚åº”å½“å‰å®¹å™¨
                        resize3DRenderer();
                    }

                    // ç”Ÿæˆ3Dæ‰‹é“¾
                    if (beadConfigs.length > 0) {
                        instructions.textContent = 'åŠ è½½ä¸­...';
                        generate3DBracelet();

                        // å»¶è¿Ÿæ›´æ–°æŒ‡ä»¤ï¼Œç­‰å¾…çº¹ç†åŠ è½½
                        setTimeout(() => {
                            instructions.textContent = isMobileDevice() ? 'è§¦æ‘¸æ‹–æ‹½æ—‹è½¬ï¼ŒåŒæŒ‡ç¼©æ”¾' : 'é¼ æ ‡æ‹–æ‹½æ—‹è½¬ï¼Œæ»šè½®ç¼©æ”¾';
                        }, 2000);
                    } else {
                        instructions.textContent = 'è¯·å…ˆé…ç½®ç å­';
                    }
                }, 100);
            }
        }

        // ä¿®æ”¹åŸæœ‰çš„ç”Ÿæˆå‡½æ•°ï¼ŒåŒæ—¶æ”¯æŒ2Då’Œ3D
        function generateBracelet() {
            console.log('generateBraceletè¢«è°ƒç”¨ï¼Œå½“å‰è§†å›¾:', currentView);
            console.log('å½“å‰ç å­æ•°é‡:', currentBeadCount);
            console.log('é€‰ä¸­åœˆå£:', selectedCircumference);
            console.log('ç»Ÿä¸€å°ºå¯¸:', uniformBeadSize);

            // ç§»åŠ¨ç«¯æ˜¾ç¤ºåŠ è½½æç¤º
            let loadingTip = null;
            if (isMobileDevice()) {
                loadingTip = showMobileLoadingTip('ğŸ”® æ­£åœ¨ç”Ÿæˆæ‰‹é“¾é¢„è§ˆ...');
            }

            // å»¶è¿Ÿæ‰§è¡Œï¼Œè®©åŠ è½½æç¤ºå…ˆæ˜¾ç¤º
            setTimeout(() => {
                try {
                    if (currentView === '2d') {
                        console.log('è°ƒç”¨2Dç”Ÿæˆå‡½æ•°');
                        generateBracelet2D();
                    } else {
                        console.log('è°ƒç”¨3Dç”Ÿæˆå‡½æ•°');
                        generate3DBracelet();
                    }
                } finally {
                    // éšè—åŠ è½½æç¤º
                    if (loadingTip) {
                        setTimeout(() => hideMobileLoadingTip(loadingTip), 500);
                    }
                }
            }, 100);
        }

        // 2Dæ‰‹é“¾ç”Ÿæˆå‡½æ•°
        async function generateBracelet2D() {
            console.log('å¼€å§‹ç”Ÿæˆ2Dæ‰‹é“¾...');
            console.log('beadConfigsé•¿åº¦:', beadConfigs.length);
            console.log('beadConfigså†…å®¹:', beadConfigs);

            if (beadConfigs.length === 0) {
                console.warn('ç å­é…ç½®ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆæ‰‹é“¾');
                return;
            }

            const canvas = document.getElementById('braceletCanvas');
            if (!canvas) {
                console.error('æ‰¾ä¸åˆ°ç”»å¸ƒå…ƒç´ ');
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('æ— æ³•è·å–ç”»å¸ƒä¸Šä¸‹æ–‡');
                return;
            }

            console.log('ç”»å¸ƒå°ºå¯¸:', canvas.width, 'x', canvas.height);

            // è°ƒç”¨é€šç”¨ç»˜åˆ¶å‡½æ•°
            await generateBracelet2DToCanvas(ctx, canvas.width, canvas.height);
            console.log('2Dæ‰‹é“¾ç”Ÿæˆå®Œæˆ');
        }

        // é€šç”¨çš„2Dæ‰‹é“¾ç»˜åˆ¶å‡½æ•°
        async function generateBracelet2DToCanvas(ctx, canvasWidth, canvasHeight) {
            console.log('å¼€å§‹ç»˜åˆ¶2Dæ‰‹é“¾åˆ°ç”»å¸ƒ...');
            console.log('ç”»å¸ƒå°ºå¯¸:', canvasWidth, 'x', canvasHeight);
            console.log('ç å­é…ç½®æ•°é‡:', beadConfigs.length);

            if (beadConfigs.length === 0) {
                console.warn('ç å­é…ç½®ä¸ºç©ºï¼Œç»˜åˆ¶æµ‹è¯•å›¾å½¢');
                // ç»˜åˆ¶æµ‹è¯•å›¾å½¢
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                ctx.fillStyle = '#667eea';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('è¯·é…ç½®ç å­', canvasWidth / 2, canvasHeight / 2);

                ctx.strokeStyle = '#667eea';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(canvasWidth / 2, canvasHeight / 2, 100, 0, 2 * Math.PI);
                ctx.stroke();
                return;
            }

            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;

            // æ¸…ç©ºç”»å¸ƒå¹¶æ·»åŠ èƒŒæ™¯
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            console.log('ç”»å¸ƒå·²æ¸…ç©º');

            // ç»˜åˆ¶é«˜è´¨é‡èƒŒæ™¯
            const bgGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, Math.max(centerX,
                centerY));
            bgGradient.addColorStop(0, 'rgba(248, 249, 250, 1)');
            bgGradient.addColorStop(0.7, 'rgba(233, 236, 239, 1)');
            bgGradient.addColorStop(1, 'rgba(206, 212, 218, 1)');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // æ·»åŠ ç»†å¾®çš„çº¹ç†
            for (let i = 0; i < 80; i++) {
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.1})`;
                ctx.fillRect(Math.random() * canvasWidth, Math.random() * canvasHeight, 1, 1);
            }

            // è®¡ç®—æ‰‹é“¾çš„å®é™…ç‰©ç†å°ºå¯¸
            const circumferenceInMm = selectedCircumference * 10;
            const totalBeadDiameter = beadConfigs.reduce((sum, bead) => sum + bead.size, 0);
            const availableSpace = circumferenceInMm - totalBeadDiameter;

            const minSpacing = 0.5;
            const calculatedSpacing = availableSpace / currentBeadCount;
            const spacing = Math.max(minSpacing, calculatedSpacing);

            let adjustedCircumference = circumferenceInMm;
            if (calculatedSpacing < minSpacing) {
                adjustedCircumference = totalBeadDiameter + (currentBeadCount * minSpacing);
            }

            const pixelsPerMm = 3;
            const displayRadius = (adjustedCircumference / (2 * Math.PI)) * pixelsPerMm;

            // è®¡ç®—ç å­ä½ç½®
            const beadPositions = [];
            const totalAngle = 2 * Math.PI;

            for (let i = 0; i < currentBeadCount; i++) {
                const beadConfig = beadConfigs[i];
                const beadDiameter = beadConfig.size;
                const beadRadius = (beadDiameter / 2) * pixelsPerMm;

                const angle = (i / currentBeadCount) * totalAngle - Math.PI / 2;

                const x = centerX + displayRadius * Math.cos(angle);
                const y = centerY + displayRadius * Math.sin(angle);

                beadPositions.push({
                    x,
                    y,
                    angle,
                    size: beadConfig.size,
                    displayRadius: beadRadius,
                    crystal: beadConfig.crystal
                });
            }

            // é¢„åŠ è½½æ‰€æœ‰éœ€è¦çš„å›¾ç‰‡
            const imagePromises = beadConfigs.map(bead =>
                preloadImage(getBeadImagePath(bead.crystal))
            );

            try {
                await Promise.all(imagePromises);
            } catch (error) {
                console.warn('éƒ¨åˆ†å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ¸²æŸ“æ–¹å¼');
            }

            // ç»˜åˆ¶æ‰‹é“¾æ•´ä½“é˜´å½±
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
            ctx.shadowBlur = 20;
            ctx.shadowOffsetX = 8;
            ctx.shadowOffsetY = 8;

            // ç»˜åˆ¶è¿æ¥çº¿ï¼ˆå¼¹åŠ›çº¿ï¼‰
            for (let i = 0; i < currentBeadCount; i++) {
                const current = beadPositions[i];
                const next = beadPositions[(i + 1) % currentBeadCount];

                const dx = next.x - current.x;
                const dy = next.y - current.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const connectionAngle = Math.atan2(dy, dx);

                const currentEdgeX = current.x + current.displayRadius * Math.cos(connectionAngle);
                const currentEdgeY = current.y + current.displayRadius * Math.sin(connectionAngle);
                const nextEdgeX = next.x - next.displayRadius * Math.cos(connectionAngle);
                const nextEdgeY = next.y - next.displayRadius * Math.sin(connectionAngle);

                const actualDistance = distance / pixelsPerMm;
                if (actualDistance > (current.size + next.size) / 2 + 1) {
                    // æ°´æ™¶å¼¹åŠ›ç»³ä¸»ä½“
                    const ropeGradient = ctx.createLinearGradient(currentEdgeX, currentEdgeY, nextEdgeX, nextEdgeY);
                    ropeGradient.addColorStop(0, 'rgba(220, 220, 255, 0.8)');
                    ropeGradient.addColorStop(0.3, 'rgba(240, 240, 255, 0.9)');
                    ropeGradient.addColorStop(0.7, 'rgba(240, 240, 255, 0.9)');
                    ropeGradient.addColorStop(1, 'rgba(220, 220, 255, 0.8)');

                    ctx.strokeStyle = ropeGradient;
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(currentEdgeX, currentEdgeY);
                    ctx.lineTo(nextEdgeX, nextEdgeY);
                    ctx.stroke();

                    // é«˜å…‰æ•ˆæœ
                    const highlightGradient = ctx.createLinearGradient(currentEdgeX, currentEdgeY, nextEdgeX,
                        nextEdgeY);
                    highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.6)');
                    highlightGradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.8)');
                    highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0.6)');

                    ctx.strokeStyle = highlightGradient;
                    ctx.lineWidth = 1;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(currentEdgeX, currentEdgeY - 1);
                    ctx.lineTo(nextEdgeX, nextEdgeY - 1);
                    ctx.stroke();

                    // åå…‰ç‚¹
                    const midX = (currentEdgeX + nextEdgeX) / 2;
                    const midY = (currentEdgeY + nextEdgeY) / 2;

                    ctx.save();
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                    ctx.shadowBlur = 3;
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.beginPath();
                    ctx.arc(midX, midY - 0.5, 0.8, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.restore();
                }
            }

            ctx.restore();

            // æŒ‰æ·±åº¦æ’åºç å­
            const sortedBeads = beadPositions.map((bead, index) => ({
                    ...bead,
                    index
                }))
                .sort((a, b) => a.y - b.y);

            // ç»˜åˆ¶ç å­
            for (let sortedBead of sortedBeads) {
                const bead = sortedBead;
                const crystal = crystalConfig[bead.crystal];
                const imagePath = getBeadImagePath(bead.crystal);

                ctx.save();
                ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
                ctx.shadowBlur = bead.displayRadius * 0.3;
                ctx.shadowOffsetX = bead.displayRadius * 0.15;
                ctx.shadowOffsetY = bead.displayRadius * 0.15;

                const img = imageCache.get(imagePath);
                if (img) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(bead.x, bead.y, bead.displayRadius, 0, 2 * Math.PI);
                    ctx.clip();

                    const imgSize = bead.displayRadius * 2;
                    ctx.drawImage(img,
                        bead.x - bead.displayRadius,
                        bead.y - bead.displayRadius,
                        imgSize, imgSize
                    );

                    ctx.restore();

                    // é«˜å…‰æ•ˆæœ
                    const highlightGradient = ctx.createRadialGradient(
                        bead.x - bead.displayRadius * 0.4,
                        bead.y - bead.displayRadius * 0.4, 0,
                        bead.x - bead.displayRadius * 0.4,
                        bead.y - bead.displayRadius * 0.4,
                        bead.displayRadius * 0.8
                    );
                    highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.6)');
                    highlightGradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.2)');
                    highlightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(bead.x, bead.y, bead.displayRadius, 0, 2 * Math.PI);
                    ctx.clip();
                    ctx.fillStyle = highlightGradient;
                    ctx.fillRect(bead.x - bead.displayRadius, bead.y - bead.displayRadius,
                        bead.displayRadius * 2, bead.displayRadius * 2);
                    ctx.restore();

                    // è¾¹ç¼˜å…‰æ³½
                    ctx.beginPath();
                    ctx.arc(bead.x, bead.y, bead.displayRadius, 0, 2 * Math.PI);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                } else {
                    // å¤‡ç”¨æ¸å˜ç»˜åˆ¶
                    const mainGradient = ctx.createRadialGradient(
                        bead.x - bead.displayRadius * 0.3,
                        bead.y - bead.displayRadius * 0.3, 0,
                        bead.x, bead.y, bead.displayRadius
                    );

                    if (crystal.category === 'é»‘') {
                        mainGradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
                        mainGradient.addColorStop(0.2, crystal.gradient[0]);
                        mainGradient.addColorStop(0.8, crystal.gradient[1]);
                        mainGradient.addColorStop(1, 'rgba(0, 0, 0, 0.8)');
                    } else if (crystal.category === 'ç™½') {
                        mainGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                        mainGradient.addColorStop(0.3, crystal.gradient[0]);
                        mainGradient.addColorStop(0.7, crystal.gradient[1]);
                        mainGradient.addColorStop(1, 'rgba(200, 200, 200, 0.6)');
                    } else {
                        mainGradient.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                        mainGradient.addColorStop(0.2, crystal.gradient[0]);
                        mainGradient.addColorStop(0.8, crystal.gradient[1]);
                        mainGradient.addColorStop(1, 'rgba(0, 0, 0, 0.3)');
                    }

                    ctx.beginPath();
                    ctx.arc(bead.x, bead.y, bead.displayRadius, 0, 2 * Math.PI);
                    ctx.fillStyle = mainGradient;
                    ctx.fill();
                }

                ctx.restore();
            }

            // æ·»åŠ æ•´ä½“ç¯å¢ƒå…‰
            const lightGradient = ctx.createRadialGradient(centerX - 30, centerY - 30, 0, centerX, centerY, Math
                .max(centerX, centerY) * 1.2);
            lightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.15)');
            lightGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            ctx.fillStyle = lightGradient;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            // æ·»åŠ ä¿¡æ¯æ–‡å­—åˆ°æ‰‹é“¾ä¸‹æ–¹
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
            ctx.shadowBlur = 3;
            ctx.shadowOffsetX = 1;
            ctx.shadowOffsetY = 1;

            const textStartY = centerY + displayRadius + 30;

            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 14px Microsoft YaHei';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const crystalTypes = [...new Set(beadConfigs.map(bead => bead.crystal))];
            if (crystalTypes.length === 1) {
                const crystal = crystalConfig[crystalTypes[0]];
                ctx.fillText(`${crystal.name} æ‰‹é“¾`, centerX, textStartY);
            } else {
                ctx.fillText(`${crystalTypes.length}ç§æ°´æ™¶æ­é…`, centerX, textStartY);
            }

            ctx.font = '11px Microsoft YaHei';
            ctx.fillText(`${currentBeadCount}é¢—ç å­ | åœˆå£${selectedCircumference}cm`, centerX, textStartY + 20);

            ctx.restore();
        }
    </script>
</body>

</html>